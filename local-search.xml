<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>mapbox-gl教程(8):矢量瓦片图层的发布与使用</title>
    <link href="/2022/04/28/2022-04-28-mapbox-gl-tutorial-8/"/>
    <url>/2022/04/28/2022-04-28-mapbox-gl-tutorial-8/</url>
    
    <content type="html"><![CDATA[<p>本文对矢量瓦片规范进行简单解读，并讲述如何基于java springboot发布一个矢量瓦片服务，以及前端如何展现矢量瓦片。</p><h1 id="矢量瓦片简介"><a href="#矢量瓦片简介" class="headerlink" title="矢量瓦片简介"></a>矢量瓦片简介</h1><p>矢量瓦片(mapbox-vector-tile,下简称mvt)，是mapbox的一项伟大设计，它基于protobuf，设计了一套字节压缩规范，将矢量数据压缩成了瓦片格式。</p><p>之所以叫矢量瓦片，是因为它有别于图片格式的栅格瓦片，瓦片中存放了序列化为bytes的features，并且可以在前端反序列化回features。</p><p><a href="https://github.com/mapbox/vector-tile-spec" target="_blank" rel="noopener">矢量瓦片压缩规范</a></p><p>规范中有的概念比较晦涩，所以官方有给出了一篇<a href="https://docs.mapbox.com/data/tilesets/guides/vector-tiles-standards/#encoding-geometry" target="_blank" rel="noopener">可视化的描述文档</a>，来描述数据的压缩过程</p><p>矢量瓦片包含了瓦片基本信息及若干图层，图层又包含了若干要素，而要素则由图形(geometry)和属性(attributes)组成：<br><img src="/myimgs/20220428/1.jpg" alt="矢量瓦片包含数据"></p><p>geometry和attributes的压缩设计得非常精妙，下面结合官方可视化文档进行简单说明:</p><h2 id="图形-geometry-的压缩"><a href="#图形-geometry-的压缩" class="headerlink" title="图形(geometry)的压缩"></a>图形(geometry)的压缩</h2><p>mvt为每个瓦片定义了一个瓦片坐标系，左上角坐标为(0, 0)，右下角坐标为(4096, 4096)(严格来说，4096这个值是叫做extent，可以根据需要调整，为了方便叙述，本文中extent一律采用默认值4096)<br><img src="/myimgs/20220428/2.jpg" alt="瓦片上的两个坐标系"></p><p>wgs84坐标系下的geometry，落在瓦片上时需要映射未瓦片坐标系。 例如，一条线段LINESTRING(103.31 23.35, 103.41 23.41)落在瓦片(z = 12, x = 3223, y = 1774)上时，<br>变成了LINESTRING(1794 2678, 6455 -367)<br>，具体的转换方式参考<a href="https://github.com/codingmiao/giscat/blob/main/giscat-vector/giscat-vector-mvt/src/test/java/org/wowtools/giscat/vector/mvt/MvtCoordinateConvertorTest.java" target="_blank" rel="noopener">这段代码</a><br>值得注意的是，线段的第二个坐标并不在范围[0, 4096]内，因为mvt允许存在在瓦片范围外的坐标，以便处理一个跨瓦片的图形在两个瓦片交界处的连接问题。<br>与之对应，示例代码中的MvtCoordinateConvertor也允许在构造方法中传入指定的缓冲半径，以合理地切割图形在范围外的部分。</p><p>随后，mvt定义了一系列数值对应MoveTo、LineTo等操作，完成了geometry在瓦片上的绘制，如下图所示：<br><img src="/myimgs/20220428/geo.gif" alt="mvt geometry"><br>可见，mvt对geometry的压缩是一种有损压缩，extent越小压缩率越高、坐标精度越低，而extent=4096是一个在视觉上看不出误差且压缩率较好的一个取值。</p><h2 id="属性-attributes-的压缩"><a href="#属性-attributes-的压缩" class="headerlink" title="属性(attributes)的压缩"></a>属性(attributes)的压缩</h2><p>我们知道，属性是以key-value的形式存储的，在一组features中，key、value的值有很大比例是重复的，于是mvt定义了一个整数型字段tags，为key、value进行唯一编号，最大限度地压缩了空间占用，如下图所示：<br><img src="/myimgs/20220428/pro.gif" alt="mvt attributes"></p><h2 id="矢量瓦片的优点"><a href="#矢量瓦片的优点" class="headerlink" title="矢量瓦片的优点"></a>矢量瓦片的优点</h2><p>1、在瓦片包含的features数量不多的前提下，矢量瓦片在体积和渲染速度上都要优于栅格瓦片</p><p>2、由于数据是矢量的，给前端提供了很大的灵活性，例如在前端动态配置要素渲染样式，点击事件可以直接选中要素等等。</p><h2 id="矢量瓦片的缺点"><a href="#矢量瓦片的缺点" class="headerlink" title="矢量瓦片的缺点"></a>矢量瓦片的缺点</h2><p>1、如果瓦片包含了太多的features，瓦片体积和渲染性能都会大幅下降。所以，我们需要合理规划好图层的展现层级，只在必要的层级展现对应的features。</p><p>2、矢量瓦片借助webgl渲染展现，对浏览器兼容性有一定要求，ie这种坑货肯定不行，就算是chrome内核，如果版本过低也会出现渲染颜色不对等问题。<br>另外，如果客户端没有GPU，那webgl会由CPU来模拟渲染，性能会下降许多。</p><h1 id="发布和展现一个矢量瓦片图层"><a href="#发布和展现一个矢量瓦片图层" class="headerlink" title="发布和展现一个矢量瓦片图层"></a>发布和展现一个矢量瓦片图层</h1><p>本节中，我们从<a href="https://datav.aliyun.com/portal/school/atlas/area_selector" target="_blank" rel="noopener">阿里云数据可视化平台</a>下载一份全国省份数据，构建一个包含三个</p><h2 id="编写并发布一个矢量瓦片服务-java"><a href="#编写并发布一个矢量瓦片服务-java" class="headerlink" title="编写并发布一个矢量瓦片服务(java)"></a>编写并发布一个矢量瓦片服务(java)</h2><p>我们基于springboot，编写一个矢量瓦片服务<br>引入springboot的maven依赖以及giscat-mvt:</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>giscat-vector-mvt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.wowtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.0-STABLE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>编写Controller，为了节约篇幅，这里把SpringBootApplication也写在同一个类中了</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.locationtech.jts.geom.*;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.wowtools.giscat.vector.pojo.Feature;<br><span class="hljs-keyword">import</span> org.wowtools.giscat.vector.pojo.FeatureCollection;<br><span class="hljs-keyword">import</span> org.wowtools.giscat.vector.pojo.converter.GeoJsonFeatureConverter;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**<br> * 用springboot起一个web服务演示矢量瓦片的使用<br> *<br> * <span class="hljs-doctag">@author</span> liuyu<br> * <span class="hljs-doctag">@date</span> 2022/4/26<br> */</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@RestController</span>()<br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/tile"</span>)<br><span class="hljs-meta">@CrossOrigin</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(WebDemo<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**<br>     * 测试数据，中国省份<br>     * 数据来源<br>     * https://datav.aliyun.com/portal/school/atlas/area_selector<br>     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FeatureCollection areaFeatureCollection;<span class="hljs-comment">//面数据</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FeatureCollection lineFeatureCollection;<span class="hljs-comment">//线数据</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FeatureCollection pointFeatureCollection;<span class="hljs-comment">//点数据</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> GeometryFactory geometryFactory = <span class="hljs-keyword">new</span> GeometryFactory();<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String vtContentType = <span class="hljs-string">"application/octet-stream"</span>;<br><br>    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getTile</span><span class="hljs-params">(@PathVariable <span class="hljs-keyword">int</span> z, @PathVariable <span class="hljs-keyword">int</span> x, @PathVariable <span class="hljs-keyword">int</span> y, HttpServletResponse response)</span> </span>&#123;<br>        <span class="hljs-comment">//构造一个MvtBuilder对象</span><br>        MvtBuilder mvtBuilder = <span class="hljs-keyword">new</span> MvtBuilder(z, x, y, geometryFactory);<br><br>        <span class="hljs-comment">//向mvt中添加layer</span><br>        MvtLayer layer = mvtBuilder.getOrCreateLayer(<span class="hljs-string">"省区域"</span>);<br>        <span class="hljs-comment">//向layer中添加feature</span><br>        <span class="hljs-keyword">for</span> (Feature feature : areaFeatureCollection.getFeatures()) &#123;<br>            <span class="hljs-comment">//这里简单地从内存中取数据并判断其是否与瓦片有交集，实际运用中可从数据库查询，例如postgis的ST_intersects函数</span><br>            <span class="hljs-keyword">if</span> (mvtBuilder.getBbox().envIntersects(feature.getGeometry())) &#123;<br>                layer.addFeature(feature);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//如法炮制添加layer</span><br>        layer = mvtBuilder.getOrCreateLayer(<span class="hljs-string">"省边界"</span>);<br>        <span class="hljs-keyword">for</span> (Feature feature : lineFeatureCollection.getFeatures()) &#123;<br>            <span class="hljs-keyword">if</span> (mvtBuilder.getBbox().envIntersects(feature.getGeometry())) &#123;<br>                layer.addFeature(feature);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//如法炮制添加layer</span><br>        layer = mvtBuilder.getOrCreateLayer(<span class="hljs-string">"省会位置"</span>);<br>        <span class="hljs-keyword">for</span> (Feature feature : pointFeatureCollection.getFeatures()) &#123;<br>            <span class="hljs-keyword">if</span> (mvtBuilder.getBbox().envIntersects(feature.getGeometry())) &#123;<br>                layer.addFeature(feature);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//数据添加完毕，转为</span><br>        <span class="hljs-keyword">byte</span>[] bytes = mvtBuilder.toBytes();<br>        exportByte(bytes, vtContentType, response);<br>    &#125;<br><br>    <span class="hljs-comment">//将bytes写进HttpServletResponse</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exportByte</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes, String contentType, HttpServletResponse response)</span> </span>&#123;<br>        response.setContentType(contentType);<br>        <span class="hljs-keyword">try</span> (OutputStream os = response.getOutputStream()) &#123;<br>            os.write(bytes);<br>            os.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (org.apache.catalina.connector.ClientAbortException e) &#123;<br>            <span class="hljs-comment">//地图移动时客户端主动取消， 产生异常"你的主机中的软件中止了一个已建立的连接"，无需处理</span><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>完整的服务端代码<a href="https://github.com/codingmiao/giscat/blob/main/giscat-vector/giscat-vector-mvt/src/test/java/org/wowtools/giscat/vector/mvt/WebDemo.java" target="_blank" rel="noopener">在这里</a><br>启动后，我们便成功发布了一个矢量瓦片服务<code>http://localhost:8080/tile/{z}/{x}/{y}</code></p><h2 id="编写前端"><a href="#编写前端" class="headerlink" title="编写前端"></a>编写前端</h2><p>新建一个空白地图，然后添加刚才发布的服务为数据源，再添加图层即可:</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-comment">// 新建一个空白地图</span><br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>    <span class="hljs-attr">container</span>: <span class="hljs-string">'map'</span>,<br>    <span class="hljs-attr">style</span>: &#123;<br>        <span class="hljs-string">"version"</span>: <span class="hljs-number">8</span>,<br>        <span class="hljs-string">"sources"</span>: &#123;&#125;,<br>        <span class="hljs-string">"layers"</span>: []<br>    &#125;,<br>    <span class="hljs-attr">center</span>: [<span class="hljs-number">102.712251</span>, <span class="hljs-number">25.040609</span>],<br>    <span class="hljs-attr">zoom</span>: <span class="hljs-number">4</span><br>&#125;);<br>map.on(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//添加刚才发布的mvt数据源</span><br>    map.addSource(<span class="hljs-string">'tile'</span>, &#123;<br>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"vector"</span>,<br>        <span class="hljs-string">"tiles"</span>: [<br>            <span class="hljs-string">'http://localhost:8080/tile/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;'</span><br>        ],<br>        <span class="hljs-string">"minZoom"</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">"maxZoom"</span>: <span class="hljs-number">22</span><br>    &#125;)<br>    <span class="hljs-comment">//添加各图层</span><br>    map.addLayer(&#123;<br>        <span class="hljs-string">"id"</span>: <span class="hljs-string">"area-layer"</span>,<br>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"fill"</span>,<br>        <span class="hljs-string">"source"</span>: <span class="hljs-string">"tile"</span>,<span class="hljs-comment">// 上一步添加的数据源id</span><br>        <span class="hljs-string">"source-layer"</span>: <span class="hljs-string">"省区域"</span>,<span class="hljs-comment">// source-layer和mvt服务中的图层名对应</span><br>        <span class="hljs-string">"layout"</span>: &#123;<span class="hljs-string">"visibility"</span>: <span class="hljs-string">"visible"</span>&#125;,<br>        <span class="hljs-string">"paint"</span>: &#123;<span class="hljs-string">"fill-color"</span>: <span class="hljs-string">'#51bbd6'</span>, <span class="hljs-string">"fill-opacity"</span>: <span class="hljs-number">0.3</span>, <span class="hljs-string">"fill-outline-color"</span>: <span class="hljs-string">'#0000ff'</span>&#125;<br>    &#125;)<br><br>    map.addLayer(&#123;<br>        <span class="hljs-string">"id"</span>: <span class="hljs-string">"point-layer"</span>,<br>        <span class="hljs-string">"source"</span>: <span class="hljs-string">'tile'</span>,<br>        <span class="hljs-string">"source-layer"</span>: <span class="hljs-string">"省会位置"</span>,<br>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"circle"</span>,<br>        <span class="hljs-string">"paint"</span>: &#123;<br>            <span class="hljs-string">"circle-color"</span>: <span class="hljs-string">"#FF00FF"</span>,<br>            <span class="hljs-string">"circle-radius"</span>: <span class="hljs-number">5</span><br>        &#125;<br>    &#125;);<br><br>    map.addLayer(&#123;<br>        <span class="hljs-string">"id"</span>: <span class="hljs-string">"route"</span>,<br>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"line"</span>,<br>        <span class="hljs-string">"source"</span>: <span class="hljs-string">'tile'</span>,<br>        <span class="hljs-string">"source-layer"</span>: <span class="hljs-string">"省边界"</span>,<br>        <span class="hljs-string">"layout"</span>: &#123;<br>            <span class="hljs-string">"line-join"</span>: <span class="hljs-string">"round"</span>,<br>            <span class="hljs-string">"line-cap"</span>: <span class="hljs-string">"round"</span><br>        &#125;,<br>        <span class="hljs-string">"paint"</span>: &#123;<br>            <span class="hljs-string">"line-color"</span>: <span class="hljs-string">"#FF0000"</span>,<br>            <span class="hljs-string">"line-width"</span>: <span class="hljs-number">3</span><br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">//矢量瓦片图层可以被点击</span><br>    map.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'area-layer'</span>, (e) =&gt; &#123;<br>        <span class="hljs-built_in">console</span>.log(e.features[<span class="hljs-number">0</span>])<br>    &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>完整的前端代码<a href="https://github.com/codingmiao/giscat/blob/main/giscat-vector/giscat-vector-mvt/src/test/resources/static/test.html" target="_blank" rel="noopener">在这里</a></p><p>展现效果如下:<br><img src="/myimgs/20220428/3.jpg" alt="最终效果"></p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mapbox-gl教程(5):常见事件与组件</title>
    <link href="/2021/08/23/2021-08-23-mapbox-gl-tutorial-5/"/>
    <url>/2021/08/23/2021-08-23-mapbox-gl-tutorial-5/</url>
    
    <content type="html"><![CDATA[<p>老实说，这一章写起来有些鸡肋，因为<a href="https://www.mapbox.cn/mapbox-gl-js/api/#map" target="_blank" rel="noopener">mapbox官方api文档</a>已经写得非常详细了，而且是中文文档且配有示例，读起来非常舒服。<br>但为了章节内容的完整性，本章仍演示了常见的事件与组件，并记录下笔者使用时遇到的坑以供参考。</p><h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>mapbox的事件， 通过<a href="https://www.mapbox.cn/mapbox-gl-js/api/#map#on" target="_blank" rel="noopener">map.on</a>函数来注册监听，<br>通过<a href="https://www.mapbox.cn/mapbox-gl-js/api/#map#on" target="_blank" rel="noopener">map.off</a>函数来移除监听。<br>这两个函数通过传入监听事件类型和回调函数来实现监听/取消监听，例如</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map.on(<span class="hljs-string">'click'</span>, (e) =&gt; &#123;<br>    <span class="hljs-built_in">console</span>.log(e)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>表示注册一个点击(click)事件，当点击地图时将点击对象打印出来。</p><p>也可以指定图层id，使得事件仅在点击到这个图层时触发:</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'poi'</span>, (e) =&gt; &#123;<br>    <span class="hljs-built_in">console</span>.log(e)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><a href="https://www.mapbox.cn/mapbox-gl-js/api/#map.event:resize" target="_blank" rel="noopener">官方文档</a>列出了所有的事件名称，大致可分为如下几类:</p><table><thead><tr><th>分类</th><th>说明</th><th>事件名称</th></tr></thead><tbody><tr><td>地图对象状态</td><td>当地图状态发生变化时触发，例如初始化完成、地图被移除、大小变化等</td><td>resize remove load</td></tr><tr><td>点击</td><td>地图被点击时触发，这类事件可以指定layerId</td><td>mousedown mouseup mouseover mousemove click dblclick mouseenter mouseleave mouseout contextmenu touchstart touchend</td></tr><tr><td>点击(不可指定图层)</td><td>地图被点击时触发，这类事件不能指定layerId</td><td>wheel touchmove touchcancel</td></tr><tr><td>显示区域变化</td><td>地图的范围、zoom、视角等变化时触发</td><td>move movestart moveend drag dragstart dragend zoom zoomstart zoomend rotatestart rotate rotateend pitchstart pitch pitchend boxzoomstart boxzoomend boxzoomcancel</td></tr><tr><td>图层展现过程</td><td>数据加载/展现渲染开始、完成等时间点上触发</td><td>render idle data styledata sourcedata dataloading styledataloading sourcedataloading styleimagemissing</td></tr><tr><td>异常</td><td>一些意外的异常产生时触发</td><td>webglcontextlost webglcontextrestored error</td></tr></tbody></table><h2 id="地图状态"><a href="#地图状态" class="headerlink" title="地图状态"></a>地图状态</h2><p>这个我们很熟悉了，前面几章的例子中，我们需要在<code>map.on(&#39;load&#39;)</code>监听map加载完成后，才能进行相关操作。</p><h2 id="点击事件-可指定图层的事件、不可指定图层的事件"><a href="#点击事件-可指定图层的事件、不可指定图层的事件" class="headerlink" title="点击事件(可指定图层的事件、不可指定图层的事件)"></a>点击事件(可指定图层的事件、不可指定图层的事件)</h2><p>通过点击事件，我们可以拿到鼠标点击的经纬度，如果指定了图层id，我们还能拿到图层中被点击的要素:</p><div>    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet' />    <div id='map1' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map1 = new mapboxgl.Map({            container: 'map1',            style: 'mapbox://styles/mapbox/streets-v11',            center: [-100.04, 38.907],            zoom: 3        });        map1.on('load', function () {            map1.addLayer({                'id': 'states-layer',                'type': 'fill',                'source': {                    'type': 'geojson',                    'data': 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_1_states_provinces_shp.geojson'                },                'paint': {                    'fill-color': 'rgba(200, 100, 240, 0.4)',                    'fill-outline-color': 'rgba(200, 100, 240, 1)'                }            });            map1.on('click', 'states-layer', function (e) {                alert(e.features[0].properties.name + ' ' + e.lngLat.lng + ',' + e.lngLat.lat)            });        });    </script></div><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map1.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'states-layer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>&#123;<br>    alert(e.features[<span class="hljs-number">0</span>].properties.name + <span class="hljs-string">' '</span> + e.lngLat.lng + <span class="hljs-string">','</span> + e.lngLat.lat)<br>&#125;);<br></code></pre></div></td></tr></table></figure><h2 id="显示区域变化"><a href="#显示区域变化" class="headerlink" title="显示区域变化"></a>显示区域变化</h2><p>通过监听区域的变化，我们可以做很多基于地图范围的事情，例如，我们的某个图层数据量很大，一次性加载到前端会给浏览器很大压力， 此时我们可以考虑在moveend事件触发时再去加载可视范围内的数据，这样就大大减少了数据量，又不会影响视觉效果。</p><h2 id="图层展现过程"><a href="#图层展现过程" class="headerlink" title="图层展现过程"></a>图层展现过程</h2><p>mapbox中的图层展现出来，需要经历数据加载和图层渲染两个过程，我们可以监听这个过程中的关键节点来做一些事情。 例如，我们可以在矢量瓦片数据加载完成时，把瓦片中的水系数据清空，这样地图上就看不到水系图层了。</p><div>    <div id='map0' style='width: 90%; height: 300px;'></div>    <script>        const map0 = new mapboxgl.Map({            container: 'map0',            style: 'mapbox://styles/mapbox/streets-v11',            center: [-100.04, 38.907],            zoom: 3        });        map0.on('data',(e)=>{            if(!e.tile || !e.tile.buckets){                return            }            const tile  = e.tile;            const buckets = tile.buckets;            for(let key in buckets){                if(key.indexOf('water')>=0){                    delete buckets[key]                }            }        })    </script></div><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map0.on(<span class="hljs-string">'data'</span>, (e) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (!e.tile || !e.tile.buckets) &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">const</span> tile = e.tile;<br>    <span class="hljs-keyword">const</span> buckets = tile.buckets;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> buckets) &#123;<br>        <span class="hljs-keyword">if</span> (key.indexOf(<span class="hljs-string">'water'</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">delete</span> buckets[key]<br>        &#125;<br>    &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>（当然这个例子并没有实际用途，我们不需要水系图层的话，设置图层的可见性或者直接把图层移除即可，不必如此复杂。 这里只是演示一下data函数的用法，在后续熟悉了矢量瓦片的字节格式后，我们就可以玩出在前端直接改矢量瓦片数据的骚操作了）</p><h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><p>官方的叫法是<a href="https://www.mapbox.cn/mapbox-gl-js/api/#user%20interface" target="_blank" rel="noopener">User Interface</a><br>主要有如下几种组件：</p><table><thead><tr><th>名称</th><th>作用</th></tr></thead><tbody><tr><td>control</td><td>在地图的四个角落放一些小工具按钮(官方提供的或是自己写的)</td></tr><tr><td>popup</td><td>在地图上放一个弹出框</td></tr><tr><td>marker</td><td>标记，把一个图标放在地图上</td></tr></tbody></table><h2 id="control"><a href="#control" class="headerlink" title="control"></a>control</h2><p>这个例子是在地图左上角放了两个control:官方自带的导航控件NavigationControl以及我们自己编写的2.5d视角控件</p><div>    <div id='map2' style='width: 90%; height: 300px;'></div>    <button id="btn3d">3d</button>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map2 = new mapboxgl.Map({            container: 'map2',            style: 'mapbox://styles/mapbox/streets-v11',            center: [-100.04, 38.907],            zoom: 3        });        map2.addControl(new mapboxgl.NavigationControl(), "top-left");        class PitchToggle {            constructor({ bearing = -20, pitch = 70, minpitchzoom = null }) {                this._bearing = bearing;                this._pitch = pitch;                this._minpitchzoom = minpitchzoom;            }            onAdd(map) {                this._map = map;                let _this = this;                this._btn = document.getElementById('btn3d');                this._btn.onclick = function() {                    if (map.getPitch() === 0) {                        let options = { pitch: _this._pitch, bearing: _this._bearing };                        if (_this._minpitchzoom && map.getZoom() > _this._minpitchzoom) {                            options.zoom = _this._minpitchzoom;                        }                        map.easeTo(options);                    } else {                        map.easeTo({ pitch: 0, bearing: 0 });                    }                };                this._container = document.createElement("div");                this._container.className = "mapboxgl-ctrl-group mapboxgl-ctrl";                this._container.appendChild(this._btn);                return this._container;            }            onRemove() {                this._container.parentNode.removeChild(this._container);                this._map = undefined;            }        }        map2.addControl(new PitchToggle({ minpitchzoom: 11 }), "top-left");    </script></div><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'map2'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width: 90%; height: 300px;'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn3d"</span>&gt;</span>3d<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><br>    mapboxgl.accessToken = <span class="hljs-string">'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA'</span>;<br>    <span class="hljs-keyword">const</span> map2 = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>        <span class="hljs-attr">container</span>: <span class="hljs-string">'map2'</span>,<br>        <span class="hljs-attr">style</span>: <span class="hljs-string">'mapbox://styles/mapbox/streets-v11'</span>,<br>        <span class="hljs-attr">center</span>: [<span class="hljs-number">-100.04</span>, <span class="hljs-number">38.907</span>],<br>        <span class="hljs-attr">zoom</span>: <span class="hljs-number">3</span><br>    &#125;);<br>    <br>    <span class="hljs-comment">//官方控件</span><br>    map2.addControl(<span class="hljs-keyword">new</span> mapboxgl.NavigationControl(), <span class="hljs-string">"top-left"</span>);<br>    <br>    <span class="hljs-comment">//自定义控件 </span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PitchToggle</span> </span>&#123;<br>        <span class="hljs-keyword">constructor</span>(&#123; bearing = <span class="hljs-number">-20</span>, pitch = <span class="hljs-number">70</span>&#125;) &#123;<br>            <span class="hljs-keyword">this</span>._bearing = bearing;<br>            <span class="hljs-keyword">this</span>._pitch = pitch;<br>        &#125;<br>        onAdd(map) &#123;<br>            <span class="hljs-keyword">this</span>._map = map;<br>            <span class="hljs-keyword">let</span> _this = <span class="hljs-keyword">this</span>;<br>            <span class="hljs-keyword">this</span>._btn = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'btn3d'</span>);<br>            <span class="hljs-keyword">this</span>._btn.onclick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>                <span class="hljs-keyword">if</span> (map.getPitch() === <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">let</span> options = &#123; <span class="hljs-attr">pitch</span>: _this._pitch, <span class="hljs-attr">bearing</span>: _this._bearing &#125;;<br>                    options.zoom = _this._minpitchzoom;<br>                    map.easeTo(options);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    map.easeTo(&#123; <span class="hljs-attr">pitch</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">bearing</span>: <span class="hljs-number">0</span> &#125;);<br>                &#125;<br>            &#125;;<br>            <span class="hljs-keyword">this</span>._container = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);<br>            <span class="hljs-keyword">this</span>._container.className = <span class="hljs-string">"mapboxgl-ctrl-group mapboxgl-ctrl"</span>;<br>            <span class="hljs-keyword">this</span>._container.appendChild(<span class="hljs-keyword">this</span>._btn);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._container;<br>        &#125;<br>        onRemove() &#123;<br>            <span class="hljs-keyword">this</span>._container.parentNode.removeChild(<span class="hljs-keyword">this</span>._container);<br>            <span class="hljs-keyword">this</span>._map = <span class="hljs-literal">undefined</span>;<br>        &#125;<br>    &#125;<br>    map2.addControl(<span class="hljs-keyword">new</span> PitchToggle(&#123; <span class="hljs-attr">minpitchzoom</span>: <span class="hljs-number">11</span> &#125;), <span class="hljs-string">"top-left"</span>);<br></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h2 id="popup"><a href="#popup" class="headerlink" title="popup"></a>popup</h2><p>结合我们点击事件的例子，现在把alert改成一个弹出框气泡:</p><div>    <div id='map3' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map3 = new mapboxgl.Map({            container: 'map3',            style: 'mapbox://styles/mapbox/streets-v11',            center: [-100.04, 38.907],            zoom: 3        });        map3.on('load', function () {            map3.addLayer({                'id': 'states-layer',                'type': 'fill',                'source': {                    'type': 'geojson',                    'data': 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_1_states_provinces_shp.geojson'                },                'paint': {                    'fill-color': 'rgba(200, 100, 240, 0.4)',                    'fill-outline-color': 'rgba(200, 100, 240, 1)'                }            });            map3.on('click', 'states-layer', function (e) {                new mapboxgl.Popup()                    .setLngLat(e.lngLat)                    .setHTML(e.features[0].properties.name)                    .addTo(map3);            });        });    </script></div><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map3.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'states-layer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>&#123;<br>    <span class="hljs-keyword">new</span> mapboxgl.Popup()<br>        .setLngLat(e.lngLat)<br>        .setHTML(e.features[<span class="hljs-number">0</span>].properties.name)<br>        .addTo(map3);<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>实际开发中，我们往往会把<code>setHTML</code>换成<a href="https://www.mapbox.cn/mapbox-gl-js/api/#popup#setdomcontent" target="_blank" rel="noopener">setDOMContent</a>，从而避免html字符串拼接，更有利于前端设计出美观的弹出框</p><h2 id="marker"><a href="#marker" class="headerlink" title="marker"></a>marker</h2><p>marker用于在地图上画一个图标，并支持拖拽这个图标，其性能相比构造一个点图层要差很多，几百个marker打到地图上就能感到卡顿。<br>因此，除非有明确的拖动需求（比如编辑数据），或者临时性的打点，一般建议用点图层来替代marker。</p><p><a href="https://www.mapbox.cn/mapbox-gl-js/example/drag-a-marker/" target="_blank" rel="noopener">这个例子</a>演示了如何创建一个可拖动的marker。</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>用libsvm-java做数据分类</title>
    <link href="/2021/02/01/2021-02-01-libsvm-java/"/>
    <url>/2021/02/01/2021-02-01-libsvm-java/</url>
    
    <content type="html"><![CDATA[<p>svm是什么？啦啦，这个问题说起来比较费劲，感兴趣的话可以去看看<a href="https://zhuanlan.zhihu.com/p/77750026" target="_blank" rel="noopener">这篇知乎大佬写的文章</a></p><p>本文要说的是svm能做什么，以及怎么用代码来做。</p><h1 id="1-svm能做什么"><a href="#1-svm能做什么" class="headerlink" title="1 svm能做什么"></a>1 svm能做什么</h1><p>先看下面这个<a href="https://www.csie.ntu.edu.tw/~cjlin/libsvm/" target="_blank" rel="noopener">例子</a>：</p><p><img src="/myimgs/20210201/2.gif" alt="svm分类"></p><p>在平面坐标系上画了红黄蓝种颜色的点若干个，然后我们画几条线，把平面划分为三个区域，使得相同颜色的点落在同一区域内。<br>如此一来，给出任意一个点的坐标，我们就能确定它落在哪个区域内，从而将它分类。<br>用稍微数字化一点的表达就是,svm能解决下列问题:</p><figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">已知:<br>当x=[1,2]时，<span class="hljs-attribute">y</span>=<span class="hljs-string">'红'</span>;<br>当x=[3,2]时，<span class="hljs-attribute">y</span>=<span class="hljs-string">'红'</span>;<br>当x=[4,3]时，<span class="hljs-attribute">y</span>=<span class="hljs-string">'黄'</span>;<br>当x=[5,1]时，<span class="hljs-attribute">y</span>=<span class="hljs-string">'黄'</span>;<br>当x=[2,6]时，<span class="hljs-attribute">y</span>=<span class="hljs-string">'蓝'</span>;<br><span class="hljs-built_in">..</span><span class="hljs-built_in">..</span><br><br>求:<br>当x=[3,7]时，<span class="hljs-attribute">y</span>=?<br></code></pre></div></td></tr></table></figure><p>最常见的用途就是验证码识别:我们把读取验证码图片上各像素点的灰度值(0~255)，得到了一个向量，然后手工录入这张图片上的字母，形成样本，把很多张图片样本经过训练后得到一个svm模型。</p><p>此后，我们传入一张新图片，就能知道图片上有什么字母了。(当然，这只是个理想过程，实际上还要辅以一些图像预处理手段等等)</p><h1 id="2-libsvm-java的使用示例"><a href="#2-libsvm-java的使用示例" class="headerlink" title="2 libsvm-java的使用示例"></a>2 libsvm-java的使用示例</h1><p><a href="https://github.com/cjlin1/libsvm" target="_blank" rel="noopener">libsvm-java</a> 是最著名的svm java库。</p><p>下面的例子中，我们用svm来判断某个属于哪个象限。<br><img src="/myimgs/20210201/1.jpg" alt="四个象限"><br>有同学要问，判断象限用x、y的正负不就可以了么？是的，这个例子是可以用公式直接判断的，正是因为它简单，我们才能简洁地说明svm的步骤，并能方便地构造样本和验证结果。<br>理解了这个简单的套路，在图像识别等复杂得无法用公式判断的场景，我们也可以按这个套路进行。</p><h2 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h2><p>引入maven依赖即可使用</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tw.edu.ntu.csie<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>libsvm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>然而这个库用起来相当恶心：完全c语言的命名风格，用System.out.println来打印日志等等。。好在源码数量不多。<br>所以，建议你先用maven依赖跑起来熟悉一下，正式使用时从 <a href="https://github.com/cjlin1/libsvm/tree/master/java" target="_blank" rel="noopener">https://github.com/cjlin1/libsvm/tree/master/java</a> 上把源码拷下来自己把觉得恶心的地方改掉。</p><h2 id="2-2-构造样本"><a href="#2-2-构造样本" class="headerlink" title="2.2 构造样本"></a>2.2 构造样本</h2><p>前面说了，判断象限可以直接用x、y的正负，所以我们先写一个判断象限的方法，并以此随机生成样本:</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><br><span class="hljs-comment">/**<br> * 判断输入的点在第几象限<br> *<br> * <span class="hljs-doctag">@param</span> x<br> * <span class="hljs-doctag">@param</span> y<br> * <span class="hljs-doctag">@return</span> 1 2 3 4<br> * 4  |  1<br> * ----|----<br> * 3  |  2<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getQuadrant</span><span class="hljs-params">(<span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> sampleNum = <span class="hljs-number">100</span>;<span class="hljs-comment">//样本数量</span><br><span class="hljs-keyword">double</span>[][] features = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[sampleNum][];<span class="hljs-comment">//特征向量数组 本例中即xy坐标构成的向量</span><br><span class="hljs-keyword">double</span>[] targetValues = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[sampleNum];<span class="hljs-comment">//分类值数组 本例中即点属于哪个象限</span><br>Random random = <span class="hljs-keyword">new</span> Random(<span class="hljs-number">233</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sampleNum; i++) &#123;<br><span class="hljs-comment">//每次循环随机生成一条样本数据</span><br><span class="hljs-comment">//随机在[-100,100)直接生成x、y坐标</span><br><span class="hljs-keyword">double</span> x = random.nextInt(<span class="hljs-number">200</span>) - <span class="hljs-number">100</span>;<br><span class="hljs-keyword">double</span> y = random.nextInt(<span class="hljs-number">200</span>) - <span class="hljs-number">100</span>;<br><span class="hljs-keyword">int</span> quadrant = getQuadrant(x, y);<span class="hljs-comment">//样本分类，实际应用中分类一般需要手工录入，本例中获取象限有公式我们就自己生成了</span><br><span class="hljs-comment">//坐标值归一化，特征向量的值需要在[0,1]间，所以需要归一化</span><br><span class="hljs-keyword">double</span> normalizationX = (x + <span class="hljs-number">100</span>) / <span class="hljs-number">200</span>;<br><span class="hljs-keyword">double</span> normalizationY = (y + <span class="hljs-number">100</span>) / <span class="hljs-number">200</span>;<br><span class="hljs-comment">//把特征向量和分类值丢到数组里</span><br>features[i] = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[]&#123;normalizationX, normalizationY&#125;;<br>targetValues[i] = quadrant;<br></code></pre></div></td></tr></table></figure><h2 id="2-3-训练模型"><a href="#2-3-训练模型" class="headerlink" title="2.3 训练模型"></a>2.3 训练模型</h2><p>有了样本，我们就可以拿来训练了，写一个训练的方法，除了调参的部分，这个方法是可以复用的：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**<br> * 训练模型<br> * <span class="hljs-doctag">@param</span> features<br> * <span class="hljs-doctag">@param</span> targetValues<br> * <span class="hljs-doctag">@return</span><br> */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> svm_model <span class="hljs-title">train</span><span class="hljs-params">(<span class="hljs-keyword">double</span>[][] features, <span class="hljs-keyword">double</span>[] targetValues)</span> </span>&#123;<br>    svm_node[][] svmNodes = <span class="hljs-keyword">new</span> svm_node[features.length][features[<span class="hljs-number">0</span>].length];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; features.length; i++) &#123;<br>        <span class="hljs-keyword">double</span>[] feature = features[i];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i1 = <span class="hljs-number">0</span>; i1 &lt; feature.length; i1++) &#123;<br>            svm_node svmNode = <span class="hljs-keyword">new</span> svm_node();<br>            svmNode.index = i1 + <span class="hljs-number">1</span>;<span class="hljs-comment">//index从1开始，所以要+1</span><br>            svmNode.value = feature[i1];<br>            svmNodes[i][i1] = svmNode;<br>        &#125;<br>    &#125;<br><br>    svm_problem sp = <span class="hljs-keyword">new</span> svm_problem();<br>    sp.x = svmNodes;<br>    sp.y = targetValues;<br>    sp.l = features.length;<br><br>    <span class="hljs-comment">//调参什么的，太深奥了，先用默认值好了</span><br>    svm_parameter prm = <span class="hljs-keyword">new</span> svm_parameter();<br>    prm.svm_type = svm_parameter.C_SVC;<br>    prm.kernel_type = svm_parameter.RBF;<br>    prm.C = <span class="hljs-number">1000</span>;<br>    prm.eps = <span class="hljs-number">0.0000001</span>;<br>    prm.gamma = <span class="hljs-number">10</span>;<br>    prm.probability = <span class="hljs-number">1</span>;<br>    prm.cache_size = <span class="hljs-number">1024</span>;<br><br>    svm_model model = svm.svm_train(sp, prm);           <span class="hljs-comment">//训练分类</span><br>    <span class="hljs-keyword">return</span> model;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>然后传入刚才生成的样本，即可训练出一个模型对象:</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">svm_model model = train(features, targetValues);<br></code></pre></div></td></tr></table></figure><p>这里我们看到了libsvm的恶心之处，对象名<code>svm_model</code>居然是小写+下划线。。。</p><p>我们也可以把训练好的模型存入文件里，下次直接读文件获取模型而免去训练过程:</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">svm.svm_save_model(<span class="hljs-string">"d:/test.md"</span>, model);<span class="hljs-comment">//写入文件</span><br>svm_model model1 = svm.svm_load_model(<span class="hljs-string">"d:/test.md"</span>);<span class="hljs-comment">//从文件读取</span><br></code></pre></div></td></tr></table></figure><h2 id="2-4-识别分类"><a href="#2-4-识别分类" class="headerlink" title="2.4 识别分类"></a>2.4 识别分类</h2><p>有了模型，我们就可以传入一个新向量来识别它是哪一类了：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//判断点(-45.5,-20.2)属于哪个象限</span><br>svm_node[] test = <span class="hljs-keyword">new</span> svm_node[]&#123;<span class="hljs-keyword">new</span> svm_node(), <span class="hljs-keyword">new</span> svm_node()&#125;;<br>test[<span class="hljs-number">0</span>].index = <span class="hljs-number">1</span>;<br>test[<span class="hljs-number">0</span>].value = -<span class="hljs-number">45.5</span>;<br>test[<span class="hljs-number">1</span>].index = <span class="hljs-number">2</span>;<br>test[<span class="hljs-number">1</span>].value = -<span class="hljs-number">20.2</span>;<br><span class="hljs-comment">//归一化</span><br>test[<span class="hljs-number">0</span>].value = (test[<span class="hljs-number">0</span>].value+<span class="hljs-number">100</span>)/<span class="hljs-number">200</span>;<br>test[<span class="hljs-number">1</span>].value = (test[<span class="hljs-number">1</span>].value+<span class="hljs-number">100</span>)/<span class="hljs-number">200</span>;<br><br><span class="hljs-keyword">double</span> result = svm.svm_predict(model, test);    <span class="hljs-comment">// 不带概率的分类</span><br>System.out.println(<span class="hljs-string">"所在象限 "</span> + result);<span class="hljs-comment">//打印  所在象限 3.0</span><br></code></pre></div></td></tr></table></figure><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wowtools.test;<br><br><br><span class="hljs-keyword">import</span> libsvm.*;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SvmTest</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">/** 1、构造样本 **/</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> sampleNum = <span class="hljs-number">100</span>;<span class="hljs-comment">//样本数量</span><br>        <span class="hljs-keyword">double</span>[][] features = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[sampleNum][];<span class="hljs-comment">//特征向量数组 本例中即xy坐标构成的向量</span><br>        <span class="hljs-keyword">double</span>[] targetValues = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[sampleNum];<span class="hljs-comment">//分类值数组 本例中即点属于哪个象限</span><br>        Random random = <span class="hljs-keyword">new</span> Random(<span class="hljs-number">233</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sampleNum; i++) &#123;<br>            <span class="hljs-comment">//每次循环随机生成一条样本数据</span><br>            <span class="hljs-comment">//随机在[-100,100)直接生成x、y坐标</span><br>            <span class="hljs-keyword">double</span> x = random.nextInt(<span class="hljs-number">200</span>) - <span class="hljs-number">100</span>;<br>            <span class="hljs-keyword">double</span> y = random.nextInt(<span class="hljs-number">200</span>) - <span class="hljs-number">100</span>;<br>            <span class="hljs-keyword">int</span> quadrant = getQuadrant(x, y);<span class="hljs-comment">//样本分类，实际应用中分类一般需要手工录入，本例中获取象限有公式我们就自己生成了</span><br>            <span class="hljs-comment">//坐标值归一化，特征向量的值需要在[0,1]间，所以需要归一化</span><br>            <span class="hljs-keyword">double</span> normalizationX = (x + <span class="hljs-number">100</span>) / <span class="hljs-number">200</span>;<br>            <span class="hljs-keyword">double</span> normalizationY = (y + <span class="hljs-number">100</span>) / <span class="hljs-number">200</span>;<br>            <span class="hljs-comment">//把特征向量和分类值丢到数组里</span><br>            features[i] = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[]&#123;normalizationX, normalizationY&#125;;<br>            targetValues[i] = quadrant;<br>        &#125;<br><br>        <span class="hljs-comment">/** 2、训练模型 **/</span><br>        svm_model model = train(features, targetValues);<br><br>        <span class="hljs-comment">/** 3、识别分类 **/</span><br>        <span class="hljs-comment">//待识别向量</span><br>        svm_node[] test = <span class="hljs-keyword">new</span> svm_node[]&#123;<span class="hljs-keyword">new</span> svm_node(), <span class="hljs-keyword">new</span> svm_node()&#125;;<br>        test[<span class="hljs-number">0</span>].index = <span class="hljs-number">1</span>;<br>        test[<span class="hljs-number">0</span>].value = -<span class="hljs-number">45.5</span>;<br>        test[<span class="hljs-number">1</span>].index = <span class="hljs-number">2</span>;<br>        test[<span class="hljs-number">1</span>].value = -<span class="hljs-number">20.2</span>;<br>        <span class="hljs-comment">//归一化</span><br>        test[<span class="hljs-number">0</span>].value = (test[<span class="hljs-number">0</span>].value+<span class="hljs-number">100</span>)/<span class="hljs-number">200</span>;<br>        test[<span class="hljs-number">1</span>].value = (test[<span class="hljs-number">1</span>].value+<span class="hljs-number">100</span>)/<span class="hljs-number">200</span>;<br><br>        <span class="hljs-keyword">double</span> result = svm.svm_predict(model, test);    <span class="hljs-comment">// 不带概率的分类测试</span><br>        System.out.println(<span class="hljs-string">"所在象限 "</span> + result);<span class="hljs-comment">//所在象限 3.0</span><br><br><span class="hljs-comment">//        double[] l = new double[4];</span><br><span class="hljs-comment">//        double result_prob = svm.svm_predict_probability(model, test, l);        //带预测概率的分类测试</span><br><span class="hljs-comment">//        System.out.println("Result with prob " + result_prob);</span><br><span class="hljs-comment">//        System.out.println("Probability " + l[0] + "\t" + l[1]);</span><br>    &#125;<br><br>    <span class="hljs-comment">/**<br>     * 训练模型<br>     * <span class="hljs-doctag">@param</span> features<br>     * <span class="hljs-doctag">@param</span> targetValues<br>     * <span class="hljs-doctag">@return</span><br>     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> svm_model <span class="hljs-title">train</span><span class="hljs-params">(<span class="hljs-keyword">double</span>[][] features, <span class="hljs-keyword">double</span>[] targetValues)</span> </span>&#123;<br>        svm_node[][] svmNodes = <span class="hljs-keyword">new</span> svm_node[features.length][features[<span class="hljs-number">0</span>].length];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; features.length; i++) &#123;<br>            <span class="hljs-keyword">double</span>[] feature = features[i];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i1 = <span class="hljs-number">0</span>; i1 &lt; feature.length; i1++) &#123;<br>                svm_node svmNode = <span class="hljs-keyword">new</span> svm_node();<br>                svmNode.index = i1 + <span class="hljs-number">1</span>;<span class="hljs-comment">//index从1开始，所以要+1</span><br>                svmNode.value = feature[i1];<br>                svmNodes[i][i1] = svmNode;<br>            &#125;<br>        &#125;<br><br>        svm_problem sp = <span class="hljs-keyword">new</span> svm_problem();<br>        sp.x = svmNodes;<br>        sp.y = targetValues;<br>        sp.l = features.length;<br><br>        <span class="hljs-comment">//调参什么的，太深奥了，先用默认值好了</span><br>        svm_parameter prm = <span class="hljs-keyword">new</span> svm_parameter();<br>        prm.svm_type = svm_parameter.C_SVC;<br>        prm.kernel_type = svm_parameter.RBF;<br>        prm.C = <span class="hljs-number">1000</span>;<br>        prm.eps = <span class="hljs-number">0.0000001</span>;<br>        prm.gamma = <span class="hljs-number">10</span>;<br>        prm.probability = <span class="hljs-number">1</span>;<br>        prm.cache_size = <span class="hljs-number">1024</span>;<br><br>        svm_model model = svm.svm_train(sp, prm);           <span class="hljs-comment">//训练分类</span><br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-comment">/**<br>     * 判断输入的点在第几象限<br>     *<br>     * <span class="hljs-doctag">@param</span> x<br>     * <span class="hljs-doctag">@param</span> y<br>     * <span class="hljs-doctag">@return</span> 1 2 3 4<br>     * 4  |  1<br>     * ----|----<br>     * 3  |  2<br>     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getQuadrant</span><span class="hljs-params">(<span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
      <category>算法工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>svm 数据分类</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mapbox-gl教程(4):适配国内底图</title>
    <link href="/2020/12/29/2020-12-29-mapbox-gl-tutorial-4/"/>
    <url>/2020/12/29/2020-12-29-mapbox-gl-tutorial-4/</url>
    
    <content type="html"><![CDATA[<p>回到背景地图(底图)上来，我们发现，底图上的标注文字大部分都是英文的，这对国内用户很不友好。<br>本章将介绍一些处理方法，同时本章还涉及到一种常见的数据源/图层:栅格瓦片</p><h1 id="方式一-使用mapbox的汉化插件"><a href="#方式一-使用mapbox的汉化插件" class="headerlink" title="方式一 使用mapbox的汉化插件"></a>方式一 使用mapbox的汉化插件</h1><div>    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet'/>    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'></script>    <div id='map1' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map1 = new mapboxgl.Map({            container: 'map1',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.405419, 39.923568],            zoom: 11        });        mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.0/mapbox-gl-rtl-text.js');        var languageControl = new MapboxLanguage({            defaultLanguage: 'zh'//设置语言为中文        });        map1.addControl(languageControl);    </script></div><p>引入插件</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>新建汉化Control对象，并添加到map中即可：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">mapboxgl.accessToken = <span class="hljs-string">'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA'</span>;<br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>    <span class="hljs-attr">container</span>: <span class="hljs-string">'map'</span>,<br>    <span class="hljs-attr">style</span>: <span class="hljs-string">'mapbox://styles/mapbox/streets-v9'</span>,<br>    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.405419</span>, <span class="hljs-number">39.923568</span>],<br>    <span class="hljs-attr">zoom</span>: <span class="hljs-number">11</span><br>&#125;);<br>mapboxgl.setRTLTextPlugin(<span class="hljs-string">'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.0/mapbox-gl-rtl-text.js'</span>);<br><span class="hljs-keyword">var</span> languageControl = <span class="hljs-keyword">new</span> MapboxLanguage(&#123;<br>    <span class="hljs-attr">defaultLanguage</span>: <span class="hljs-string">'zh'</span><span class="hljs-comment">//设置语言为中文</span><br>&#125;);<br>map.addControl(languageControl);<br></code></pre></div></td></tr></table></figure><p>实际用下来，这种方式效果一般，依然有少量的英文标注，而且由于是国外的数据源，POI的密度也比较低。</p><h1 id="方式二-使用国内数据源"><a href="#方式二-使用国内数据源" class="headerlink" title="方式二 使用国内数据源"></a>方式二 使用国内数据源</h1><p><a href="https://www.tianditu.gov.cn/" target="_blank" rel="noopener">国家地理信息公共服务平台“天地图”</a>（以下简称“天地图“）是国家基础地理信息中心建设的网络化地理信息共享与服务门户。<br>天地图提供的背景地图，国家背景、更新及时、地物详细、完全免费、值得信赖。本小节我们就来学习如何将mapbox的背景地图换成天地图的：</p><div>    <div id='map' style='width: 90%; height: 300px;'></div>    <script>        const map = new mapboxgl.Map({            container: 'map',            style: {//为map构造一个空的style                "version": 8,                "sources": {},                "layers": [],            },            center: [116.405419, 39.923568],            zoom: 11        });        //天地图的token        const tiandituToken = 'd12deb9576426df9aff82075b754790a';        //下面几组url代表不同的底图，根据需要选用        //矢量底图        const vecwUrl = 'https://t0.tianditu.gov.cn/vec_w/wmts?' +            'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&' +            'TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=' + tiandituToken;        //矢量注记        const cvawUrl = 'https://t3.tianditu.gov.cn/cva_w/wmts?' +            'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&' +            'TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=' + tiandituToken;        //影像底图        const imgUrl = 'https://t6.tianditu.gov.cn/img_w/wmts?' +            'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&' +            'TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=' + tiandituToken;        //影像注记        const imgwUrl = 'https://t0.tianditu.gov.cn/cia_w/wmts?' +            'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&' +            'TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=' + tiandituToken;        /**         * 向地图中添加一个栅格瓦片图层         * @param map         * @param url 瓦片url         * @param sourceId 数据源id，保证唯一性即可         * @param layerId 图层id，保证唯一性即可         */        function addRasterTileLayer(map, url, sourceId, layerId) {            map.addSource(sourceId, {                type: 'raster',                tiles: [url],                tileSize: 256            });            map.addLayer({                id: layerId,                type: 'raster',                source: sourceId            });        }        map.on('load', function () {            //这里选择加载矢量底图及其标注            addRasterTileLayer(map, vecwUrl, 'vecw', 'vecw')            addRasterTileLayer(map, cvawUrl, 'cvaw', 'cvaw')        })    </script></div>emmm，这下好多了，看下代码：<figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>    <span class="hljs-attr">container</span>: <span class="hljs-string">'map'</span>,<br>    <span class="hljs-attr">style</span>: &#123;<span class="hljs-comment">//为map构造一个空的style</span><br>        <span class="hljs-string">"version"</span>: <span class="hljs-number">8</span>,<br>        <span class="hljs-string">"sources"</span>: &#123;&#125;,<br>        <span class="hljs-string">"layers"</span>: [],<br>    &#125;,<br>    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.405419</span>, <span class="hljs-number">39.923568</span>],<br>    <span class="hljs-attr">zoom</span>: <span class="hljs-number">11</span><br>&#125;);<br><br><span class="hljs-comment">//天地图的token</span><br><span class="hljs-keyword">const</span> tiandituToken = <span class="hljs-string">'d12deb9576426df9aff82075b754790a'</span>;<br><span class="hljs-comment">/*<br>* 天地图提供了多种背景地图和标注供选择，<br>* 只要从http://lbs.tianditu.gov.cn/server/MapService.html找到对应的url即可<br>* 这里使用了了矢量地图和注记<br>* */</span><br><span class="hljs-comment">//矢量底图</span><br><span class="hljs-keyword">const</span> vecwUrl = <span class="hljs-string">'https://t0.tianditu.gov.cn/vec_w/wmts?'</span> +<br>    <span class="hljs-string">'SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=vec&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;'</span> +<br>    <span class="hljs-string">'TILECOL=&#123;x&#125;&amp;TILEROW=&#123;y&#125;&amp;TILEMATRIX=&#123;z&#125;&amp;tk='</span> + tiandituToken;<br><span class="hljs-comment">//矢量注记</span><br><span class="hljs-keyword">const</span> cvawUrl = <span class="hljs-string">'https://t3.tianditu.gov.cn/cva_w/wmts?'</span> +<br>    <span class="hljs-string">'SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=cva&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;'</span> +<br>    <span class="hljs-string">'TILECOL=&#123;x&#125;&amp;TILEROW=&#123;y&#125;&amp;TILEMATRIX=&#123;z&#125;&amp;tk='</span> + tiandituToken;<br><br><span class="hljs-comment">/**<br> * 向地图中添加一个栅格瓦片图层<br> * @param map<br> * @param url 瓦片url<br> * @param sourceId 数据源id，保证唯一性即可<br> * @param layerId 图层id，保证唯一性即可<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRasterTileLayer</span>(<span class="hljs-params">map, url, sourceId, layerId</span>) </span>&#123;<br>    map.addSource(sourceId, &#123;<br>        <span class="hljs-attr">type</span>: <span class="hljs-string">'raster'</span>,<br>        <span class="hljs-attr">tiles</span>: [url],<br>        <span class="hljs-attr">tileSize</span>: <span class="hljs-number">256</span><br>    &#125;);<br>    map.addLayer(&#123;<br>        <span class="hljs-attr">id</span>: layerId,<br>        <span class="hljs-attr">type</span>: <span class="hljs-string">'raster'</span>,<br>        <span class="hljs-attr">source</span>: sourceId<br>    &#125;);<br>&#125;<br><br>map.on(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//这里选择加载矢量底图及其标注</span><br>    addRasterTileLayer(map,vecwUrl,<span class="hljs-string">'vecw'</span>,<span class="hljs-string">'vecw'</span>)<br>    addRasterTileLayer(map,cvawUrl,<span class="hljs-string">'cvaw'</span>,<span class="hljs-string">'cvaw'</span>)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>我们先构造了一个空的style，这样map对象里就不含任何数据源和图层，也就是一张空白的地图。<br>然后我们定义了一个<code>addRasterTileLayer</code>函数，用以构建栅格瓦片数据源和图层并添加到地图中。<br>最后再用天地图的瓦片url构造了一个背景图层和一个背景标注图层。</p><h1 id="栅格瓦片简介"><a href="#栅格瓦片简介" class="headerlink" title="栅格瓦片简介"></a>栅格瓦片简介</h1><p>按下F12打开开发者工具，然后滚动几下地图，你会发现mapbox请求了许多256*256的图片：<br><img src="/myimgs/20201229/1.jpg" alt="F12"><br>这些图片就是一个栅格瓦片，多个瓦片拼接完成了背景地图图层的展示。</p><p>再回过头来看下天地图的瓦片url</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vecwUrl = <span class="hljs-string">'https://t0.tianditu.gov.cn/vec_w/wmts?'</span> +<br>    <span class="hljs-string">'SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=vec&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;'</span> +<br>    <span class="hljs-string">'TILECOL=&#123;x&#125;&amp;TILEROW=&#123;y&#125;&amp;TILEMATRIX=&#123;z&#125;&amp;tk='</span> + tiandituToken;<br></code></pre></div></td></tr></table></figure><p>可以看到，url里包含了{z}、{x}、{y}三个参数，事实上，任何瓦片的url都必须包含这三个参数:<br><img src="/myimgs/20201229/2.jpg" alt="ZXY"></p><p>z即当前地图的缩放层级。<br>每个层级上，地球在水平和数值方向上都被切割成了2^z块瓦片，左上角的编号为(0,0)，并由左向右递增x、由上往下递增y。<br>所以，当我们把瓦片url传给mapbox后，mapbox就根据当前地图的层级、经纬度范围，按照这个规则去计算出需要哪些zxy对应的瓦片来填充地图，并发送请求去取图片。</p><p>瓦片图层有哪些好处呢？<br>在服务端，我们可以提前把所有zxy对应的瓦片都预先生成好并存起来(这个过程称为预切片)，这样在运行过程中服务端就几乎没什么计算压力了。<br>而客户端也只需加载视野范围内的瓦片，不用像geojson那样把所有数据都加载过来，压力也少了很多。</p><p>有同学要问了，那服务端传过来的是图片，我们没办法修改它的颜色等样式了呀，是的，所以mapbox又制定了矢量瓦片标准，瓦片里不再是一张jpg，而是压缩过的feature，<br>这样又可以在前端改样式了，矢量瓦片需要涉及一些服务端的知识，我们将在第四部分中详解。</p><p><strong>TIPS:</strong>高德、百度等地图产商也提供了栅格瓦片或矢量瓦片，如有需要，我们也可以把天地图的瓦片换成高德或百度等。<br>但是，按照高德、百度的用户协议，直接调用瓦片是不合规的；而且为了保密，这些瓦片还经过了一些偏移处理，我们需要一些纠偏手段把偏移去掉，这也是不合规的。</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mapbox-gl教程(3):添加自定义数据（小数据量的方式）(下)</title>
    <link href="/2020/12/28/2020-12-28-mapbox-gl-tutorial-3/"/>
    <url>/2020/12/28/2020-12-28-mapbox-gl-tutorial-3/</url>
    
    <content type="html"><![CDATA[<h1 id="示例的详细说明"><a href="#示例的详细说明" class="headerlink" title="示例的详细说明"></a>示例的详细说明</h1><p>我们先简单回顾一下<a href="/2020/12/25/2020-12-25-mapbox-gl-tutorial-2/">上一章</a>的demo：<br>要想展示自定义数据，我们需要先把数据做成数据源添加到map对象里，然后再新建一个图层指定样式和数据源添加到map。<br>所以在示例中，我们用构造了包含两个点的<strong>geojson</strong>数据源，然后构造了一个半径为20像素的红点<strong>样式</strong>，就完成了数据的展现工作。</p><p>接下来，我们详细了解一下geojson和样式的结构</p><h2 id="geojson"><a href="#geojson" class="headerlink" title="geojson"></a>geojson</h2><p><a href="https://tools.ietf.org/html/rfc7946" target="_blank" rel="noopener">这个网页</a>详细介绍了geojson的标准；<br><a href="https://www.oschina.net/translate/geojson-spec" target="_blank" rel="noopener">这个网页</a>对geojson标准进行了翻译。<br>总之很详细很复杂就是了。我们的应用中一般不需要这么复杂，所以这里对mapbox里geojson数据源的常用属性进行说明：</p><h3 id="要素容器-FeatureCollection"><a href="#要素容器-FeatureCollection" class="headerlink" title="要素容器(FeatureCollection)"></a>要素容器(FeatureCollection)</h3><p>mapbox的geojson数据源，data部分要传入一个FeatureCollection，格式如下：</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"FeatureCollection"</span>,<br>    <span class="hljs-attr">"features"</span>: [<br>      ...<span class="hljs-comment">//这里放要素</span><br>    ]<br>&#125;<br></code></pre></div></td></tr></table></figure><p>很简单，就是留出一个数组来放要素</p><h3 id="要素"><a href="#要素" class="headerlink" title="要素"></a>要素</h3><p>要素包含了形状(geometry)和属性(properties)</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"Feature"</span>,<br>    <span class="hljs-attr">"geometry"</span>: ...<span class="hljs-comment">//这里放形状json,</span><br>    <span class="hljs-string">"properties"</span>: ...<span class="hljs-comment">//这里放属性</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>属性就是一个key-value格式的json,如<code>{name:&quot;张三&quot;,age:25}</code></p><p>形状则根据其类型的不同有不同的格式，这里介绍一下常见的点、线、面三种类型：</p><h4 id="点形状-point"><a href="#点形状-point" class="headerlink" title="点形状(point)"></a>点形状(point)</h4><p>在coordinates属性中放了一个长度为2的数组存放经纬度</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">"type"</span>: <span class="hljs-string">"Point"</span>,<br><span class="hljs-attr">"coordinates"</span>: [<span class="hljs-number">102.0</span>, <span class="hljs-number">0.5</span>]<span class="hljs-comment">//经纬度</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="线形状-LineString"><a href="#线形状-LineString" class="headerlink" title="线形状(LineString)"></a>线形状(LineString)</h4><p>在coordinates属性中放了一组经纬度坐标存放线上每个点的经纬度</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">"type"</span>: <span class="hljs-string">"LineString"</span>,<br><span class="hljs-attr">"coordinates"</span>: [<br>[<span class="hljs-number">102.0</span>, <span class="hljs-number">0.0</span>],<br>[<span class="hljs-number">103.0</span>, <span class="hljs-number">1.0</span>],<br>[<span class="hljs-number">104.0</span>, <span class="hljs-number">0.0</span>],<br>[<span class="hljs-number">105.0</span>, <span class="hljs-number">1.0</span>]<br>]<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="面形状-Polygon"><a href="#面形状-Polygon" class="headerlink" title="面形状(Polygon)"></a>面形状(Polygon)</h4><p>在coordinates属性中放了一组经纬度坐标存面线上每个点的经纬度</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"Polygon"</span>,<br>  <span class="hljs-attr">"coordinates"</span>: [<br>    [<br>      [<span class="hljs-number">100.0</span>, <span class="hljs-number">0.0</span>],<br>      [<span class="hljs-number">101.0</span>, <span class="hljs-number">0.0</span>],<br>      [<span class="hljs-number">101.0</span>, <span class="hljs-number">1.0</span>],<br>      [<span class="hljs-number">100.0</span>, <span class="hljs-number">1.0</span>],<br>      [<span class="hljs-number">100.0</span>, <span class="hljs-number">0.0</span>]<br>    ]<br>  ]<br>&#125;<br></code></pre></div></td></tr></table></figure><p>注意，coordinates必须形成一个环，也就是第一个坐标必须与最后一个坐标必须相同；<br>Polygon的coordinates比LineString的coordinates多了一层括号，这是因为面可能由多个环组成，可以想象一下铜钱，它由一个外圈的圆和内圈的正方形构成；<br>多个环的Polygon还要注意坐标的顺时针或逆时针顺序，一个环的话就随意了。</p><h2 id="图层与样式"><a href="#图层与样式" class="headerlink" title="图层与样式"></a>图层与样式</h2><p>mapbox有很多种类型，每种类型的图层又配有对应的样式属性，一个标准的图层json格式如下:</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"id"</span>: <span class="hljs-string">"lightLinelayer"</span>,<span class="hljs-comment">//图层id</span><br>  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"line"</span>,<span class="hljs-comment">//图层类型</span><br>  <span class="hljs-attr">"source"</span>: <span class="hljs-string">"lightSource"</span>,<span class="hljs-comment">//数据源id</span><br>  <span class="hljs-attr">"layout"</span>: &#123;<span class="hljs-comment">//样式的布局属性</span><br>    <span class="hljs-attr">"line-join"</span>: <span class="hljs-string">"round"</span>,<br>    <span class="hljs-attr">"line-cap"</span>: <span class="hljs-string">"round"</span><br>  &#125;,<br>  <span class="hljs-attr">"paint"</span>: &#123;<span class="hljs-comment">//样式的绘制属性</span><br>    <span class="hljs-attr">"line-color"</span>: <span class="hljs-string">"#00FFFF"</span>,<br>    <span class="hljs-attr">"line-width"</span>: <span class="hljs-number">5</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>样式的信息散落在布局属性(layout)和绘制属性(paint)中，从人类的思维上，layout和paint并没有明显的区分，例如线宽(line-width)和线端点(line-cap)都是对线型的描述，但却分别落在了paint和layout中，<br>官方对二者的差异如下解释:</p><blockquote><p>Layout properties appear in the layer’s “layout” object. They are applied early in the rendering process and define how data for that layer is passed to the GPU. Changes to a layout property require an asynchronous “layout” step.<br>布局属性出现在图层的“layout”对象中。它们在渲染过程的早期应用，并定义该层的数据如何传递给GPU。对布局属性的更改需要一个异步的“布局”过程。<br>Paint properties are applied later in the rendering process. Paint properties appear in the layer’s”paint” object. Changes to a paint property are cheap and happen synchronously.<br>绘制属性稍后在呈现过程中应用。绘制属性出现在图层的“paint”对象中。更改绘制属性的性能很高，并且是同步的。</p></blockquote><p>也就是说二者的差异体现在渲染的机制不同，所以，具体每种图层有哪些样式属性，是layout还是paint，需要查阅<a href="https://www.mapbox.cn/mapbox-gl-js/style-spec/#layers" target="_blank" rel="noopener">官方文档</a></p><h2 id="数据和样式的修改"><a href="#数据和样式的修改" class="headerlink" title="数据和样式的修改"></a>数据和样式的修改</h2><p>下面对例子作一下扩充，我们看一下如何改变样式和数据</p><h3 id="修改样式"><a href="#修改样式" class="headerlink" title="修改样式"></a>修改样式</h3><p><code>map.setLayoutProperty</code>和<code>map.setPaintProperty</code>函数可以设置图层的布局属性和绘制属性，这个例子演示了把点的颜色来回切换：</p><div>    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet'/>    <div id='map' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map = new mapboxgl.Map({            container: 'map',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.405419, 39.923568],            zoom: 11        });        map.on('load', function () {            const mySource = {                "type": "geojson",                "data": {                    "type": "FeatureCollection",                    "features": [                        {                            "type": "Feature",                            "geometry": {                                "type": "Point",                                "coordinates": [116.338728, 39.913385]                            },                            "properties": {                                "name": "点1",                            }                        },                        {                            "type": "Feature",                            "geometry": {                                "type": "Point",                                "coordinates": [116.405419, 39.923568]                            },                            "properties": {                                "name": "点1",                                "type": "测试类型"                            }                        }                    ]                }            };            map.addSource('source1', mySource);            let currentColor = "#FF0000";            map.addLayer({                "id": "testLayer",                "source": 'source1',                "type": "circle",                "paint": {                    "circle-color": currentColor,                    "circle-radius": 20                }            });            setInterval(function (){                if("#FF0000"==currentColor){                    currentColor = "#0000FF"                }else {                    currentColor = "#FF0000"                }                map.setPaintProperty('testLayer',"circle-color",currentColor)            },1000)        });    </script></div><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">let</span> currentColor = <span class="hljs-string">"#FF0000"</span><br>map.addLayer(&#123;<br>    <span class="hljs-string">"id"</span>: <span class="hljs-string">"testLayer"</span>,<br>    <span class="hljs-string">"source"</span>: <span class="hljs-string">'source1'</span>,<br>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"circle"</span>,<br>    <span class="hljs-string">"paint"</span>: &#123;<br>        <span class="hljs-string">"circle-color"</span>: currentColor,<br>        <span class="hljs-string">"circle-radius"</span>: <span class="hljs-number">20</span><br>    &#125;<br>&#125;);<br><span class="hljs-comment">//启动一个定时器定期修改颜色</span><br>setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">"#FF0000"</span>==currentColor)&#123;<br>        currentColor = <span class="hljs-string">"#0000FF"</span><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        currentColor = <span class="hljs-string">"#FF0000"</span><br>    &#125;<br>    <span class="hljs-comment">//三个参数分别是图层id、属性名、属性值</span><br>    map.setPaintProperty(<span class="hljs-string">'testLayer'</span>,<span class="hljs-string">"circle-color"</span>,currentColor)<br>&#125;,<span class="hljs-number">1000</span>)<br></code></pre></div></td></tr></table></figure><h3 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h3><p><code>map.getSource(&#39;sourceId&#39;).setData</code>函数可以修改数据源内容，这个例子演示了修改坐标信息使红点水平移动：</p><div>    <div id='map1' style='width: 90%; height: 300px;'></div>    <script>        const map1 = new mapboxgl.Map({            container: 'map1',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.405419, 39.923568],            zoom: 11        });        map1.on('load', function () {            const mySource = {                "type": "geojson",                "data": {                    "type": "FeatureCollection",                    "features": [                        {                            "type": "Feature",                            "geometry": {                                "type": "Point",                                "coordinates": [116.338728, 39.913385]                            },                            "properties": {                                "name": "点1",                            }                        }                    ]                }            };            map1.addSource('source1', mySource);            map1.addLayer({                "id": "testLayer",                "source": 'source1',                "type": "circle",                "paint": {                    "circle-color": "#FF0000",                    "circle-radius": 20                }            });            const xmin = 116.338728, xmax = 116.405419, step = 0.0001;            const source1 = map1.getSource('source1');            let currentX = xmin;            //启动一个定时器定期修改颜色            setInterval(function () {                currentX += step                if (currentX > xmax) {                    currentX = xmin;                }                source1.setData(                    {                        "type": "FeatureCollection",                        "features": [                            {                                "type": "Feature",                                "geometry": {                                    "type": "Point",                                    "coordinates": [currentX, 39.913385]                                },                                "properties": {                                    "name": "点1",                                }                            }                        ]                    }                );            }, 10)        });    </script></div><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">const</span> mySource = &#123;<br>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"geojson"</span>,<br>    <span class="hljs-string">"data"</span>: &#123;<br>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"FeatureCollection"</span>,<br>        <span class="hljs-string">"features"</span>: [<br>            &#123;<br>                <span class="hljs-string">"type"</span>: <span class="hljs-string">"Feature"</span>,<br>                <span class="hljs-string">"geometry"</span>: &#123;<br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"Point"</span>,<br>                    <span class="hljs-string">"coordinates"</span>: [<span class="hljs-number">116.338728</span>, <span class="hljs-number">39.913385</span>]<br>                &#125;,<br>                <span class="hljs-string">"properties"</span>: &#123;<br>                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"点1"</span>,<br>                &#125;<br>            &#125;<br>        ]<br>    &#125;<br>&#125;<br>map.addSource(<span class="hljs-string">'source1'</span>, mySource)<br>map.addLayer(&#123;<br>    <span class="hljs-string">"id"</span>: <span class="hljs-string">"testLayer"</span>,<br>    <span class="hljs-string">"source"</span>: <span class="hljs-string">'source1'</span>,<br>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"circle"</span>,<br>    <span class="hljs-string">"paint"</span>: &#123;<br>        <span class="hljs-string">"circle-color"</span>: <span class="hljs-string">"#FF0000"</span>,<br>        <span class="hljs-string">"circle-radius"</span>: <span class="hljs-number">20</span><br>    &#125;<br>&#125;);<br><span class="hljs-keyword">const</span> xmin = <span class="hljs-number">116.338728</span>, xmax = <span class="hljs-number">116.405419</span>, step = <span class="hljs-number">0.0001</span><br><span class="hljs-keyword">let</span> currentX = xmin;<br><span class="hljs-keyword">const</span> source1 = map.getSource(<span class="hljs-string">'source1'</span>);<br><span class="hljs-comment">//启动一个定时器定期修改颜色</span><br>setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    currentX += step<br>    <span class="hljs-keyword">if</span> (currentX &gt; xmax) &#123;<br>        currentX = xmin;<br>    &#125;<br>    source1.setData(<br>        &#123;<br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"FeatureCollection"</span>,<br>            <span class="hljs-string">"features"</span>: [<br>                &#123;<br>                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"Feature"</span>,<br>                    <span class="hljs-string">"geometry"</span>: &#123;<br>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"Point"</span>,<br>                        <span class="hljs-string">"coordinates"</span>: [currentX, <span class="hljs-number">39.913385</span>]<br>                    &#125;,<br>                    <span class="hljs-string">"properties"</span>: &#123;<br>                        <span class="hljs-string">"name"</span>: <span class="hljs-string">"点1"</span>,<br>                    &#125;<br>                &#125;<br>            ]<br>        &#125;<br>    );<br>&#125;, <span class="hljs-number">10</span>)<br></code></pre></div></td></tr></table></figure><p>这里使用了定时器来刷新坐标，mapbox还支持<code>requestAnimationFrame</code>函数按帧来刷新，使得运动更流畅，可以看<a href="https://www.mapbox.cn/mapbox-gl-js/example/animate-point-along-line/" target="_blank" rel="noopener">这个例子</a></p><h2 id="geojson数据源的缺陷"><a href="#geojson数据源的缺陷" class="headerlink" title="geojson数据源的缺陷"></a>geojson数据源的缺陷</h2><p>你一定注意到了本章的标题“添加自定义数据（小数据量的方式）”，为什么要加小数据量这个限制呢？<br>试想，假如我们有一张数百万条数据的表，把这些数据全转为geojson再丢给mapbox渲染，那对服务端、网络、浏览器都将造成极大的压力。<br>而且即使电脑性能极佳能够撑住，显示器和人眼的分辨率有限，也无法将这些点分辨出来。</p><p>所以、gis专家们提出了分层、切片等解决方法，制定了多种数据源以适应大数据量的展示，在本教程的第四部分会详细涉及。</p><p>geojson的方式能够支撑大约一万个点的展示，在第四部分之前，我们依然将以geojson为主进行讲解。</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mapbox-gl教程(2):添加自定义数据（小数据量的方式）(上)</title>
    <link href="/2020/12/25/2020-12-25-mapbox-gl-tutorial-2/"/>
    <url>/2020/12/25/2020-12-25-mapbox-gl-tutorial-2/</url>
    
    <content type="html"><![CDATA[<p><a href="/2020/12/21/2020-12-21-mapbox-gl-tutorial-1/">上一章</a> 的hello world中，我们学会了如何构造一个地图并展现在dom内，但只是一个背景地图而已，接下来我们将学习如何添加自定义数据。</p><h1 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h1><p>先看下demo，我们在地图上添加两个红点</p><div>    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet'/>    <div id='map' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        const map = new mapboxgl.Map({            container: 'map',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.405419, 39.923568],            zoom: 11        });        map.on('load', function () {            const mySource = {                "type": "geojson",                "data": {                    "type": "FeatureCollection",                    "features": [{                        "type": "Feature",                        "geometry": {                            "type": "Point",                            "coordinates": [116.338728, 39.913385]                        },                        "properties": {                            "name": "点1",                        }                    }, {                        "type": "Feature",                        "geometry": {                            "type": "Point",                            "coordinates": [116.405419, 39.923568]                        },                        "properties": {                            "name": "点1",                            "type": "测试类型"                        }                    }]                }            };            map.addSource('source1', mySource);            map.addLayer({                "id": "testLayer",                "source": 'source1',                "type": "circle",                "paint": {                    "circle-color": "#FF0000",                    "circle-radius": 20                }            });        });    </script></div><p>这次，我们不直接看代码，先看一下mapbox的对象模型：</p><h1 id="mapbox对象模型"><a href="#mapbox对象模型" class="headerlink" title="mapbox对象模型"></a>mapbox对象模型</h1><p><img src="/myimgs/20201225/1.jpg" alt="mapbox对象模型"></p><p>如图所示，mapbox的对象分为了若干个层级：</p><h2 id="地图-map"><a href="#地图-map" class="headerlink" title="地图(map)"></a>地图(map)</h2><p>上一章中我们已经了解到，要展现地图，先要创建一个map对象并将其绑定到dom上。</p><p>一个地图下面包含了多个图层。</p><h2 id="图层-layer"><a href="#图层-layer" class="headerlink" title="图层(layer)"></a>图层(layer)</h2><p>一个地图下面包含了多个图层，例如上章的demo中，背景地图里也包含了街道、水系、形状区域等图层(这些图层在配置了style参数后，自动添加到了地图中)，<br>本章的demo中我们画的两个红点也是在一个图层中。</p><p>图层下包含了数据和样式。</p><h2 id="数据-source"><a href="#数据-source" class="headerlink" title="数据(source)"></a>数据(source)</h2><p>source的中文翻译比较多，译作“数据源”、“来源”、“要素源”之类。。source可以理解为一张数据库表，我们把表中的数据传给mapbox，才能把它展现出来。</p><p>数据由多个要素组成，每个要素可以理解为表中的一行数据。</p><h2 id="样式-style"><a href="#样式-style" class="headerlink" title="样式(style)"></a>样式(style)</h2><p>样式就是展现数据的方式，例如本章demo中把数据展现为红色的圆点，就是样式的作用。</p><h2 id="要素-feature"><a href="#要素-feature" class="headerlink" title="要素(feature)"></a>要素(feature)</h2><p>每个要素可以理解为表中的一行数据。要素中包含了两部分内容，<strong>属性(properties)</strong>和<strong>形状(geometry)</strong>。<br>属性就是常规的字段，一般用key-value的形式表示，如<code>{name:&quot;张三&quot;,age:25}</code>。<br>形状存放了要素的坐标信息。</p><h1 id="demo代码解析"><a href="#demo代码解析" class="headerlink" title="demo代码解析"></a>demo代码解析</h1><p>了解了mapbox的对象模型，我们就可以对照模型来看代码了:</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css'</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'stylesheet'</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'map'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width: 90%; height: 300px;'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript"><br>    mapboxgl.accessToken = <span class="hljs-string">'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA'</span>;<br>    <span class="hljs-comment">//地图</span><br>    <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>        container: <span class="hljs-string">'map'</span>,<br>        style: <span class="hljs-string">'mapbox://styles/mapbox/streets-v9'</span>,<br>        center: [<span class="hljs-number">116.405419</span>, <span class="hljs-number">39.923568</span>],<br>        zoom: <span class="hljs-number">11</span><br>    &#125;);<br><br>    map.on(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">//地图初始化结束后的回调函数，操作地图对象一般都在回调函数中进行，否则可能由于还没初始化完毕而产生一些奇怪的问题</span><br><br>        <span class="hljs-comment">//数据源</span><br>        <span class="hljs-keyword">const</span> mySource = &#123;<br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"geojson"</span>,<span class="hljs-comment">//注释1 数据类型</span><br>            <span class="hljs-string">"data"</span>: &#123;<span class="hljs-comment">//注释2 geojson</span><br>                <span class="hljs-string">"type"</span>: <span class="hljs-string">"FeatureCollection"</span>,<br>                <span class="hljs-string">"features"</span>: [<br>                    &#123;<span class="hljs-comment">//要素</span><br>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"Feature"</span>,<br>                        <span class="hljs-string">"geometry"</span>: &#123;<span class="hljs-comment">//形状</span><br>                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"Point"</span>,<br>                            <span class="hljs-string">"coordinates"</span>: [<span class="hljs-number">116.338728</span>, <span class="hljs-number">39.913385</span>]<span class="hljs-comment">//点的经纬度坐标</span><br>                        &#125;,<br>                        <span class="hljs-string">"properties"</span>: &#123;<span class="hljs-comment">//属性</span><br>                            <span class="hljs-string">"name"</span>: <span class="hljs-string">"点1"</span>,<br>                        &#125;<br>                    &#125;,<br>                    &#123;<span class="hljs-comment">//另一个要素</span><br>                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"Feature"</span>,<br>                        <span class="hljs-string">"geometry"</span>: &#123;<br>                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"Point"</span>,<br>                            <span class="hljs-string">"coordinates"</span>: [<span class="hljs-number">116.405419</span>, <span class="hljs-number">39.923568</span>]<br>                        &#125;,<br>                        <span class="hljs-string">"properties"</span>: &#123;<br>                            <span class="hljs-string">"name"</span>: <span class="hljs-string">"点1"</span>,<br>                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"测试类型"</span><br>                        &#125;<br>                    &#125;<br>                ]<br>            &#125;<br>        &#125;<br><br>        map.addSource(<span class="hljs-string">'source1'</span>, mySource)<span class="hljs-comment">//将数据添加到地图，指定这份数据的id为source1，id必须唯一</span><br><br>        <span class="hljs-comment">//构造一个图层并添加到地图</span><br>        map.addLayer(&#123;<br>            <span class="hljs-string">"id"</span>: <span class="hljs-string">"testLayer"</span>,<span class="hljs-comment">//图层id，必须唯一</span><br>            <span class="hljs-string">"source"</span>: <span class="hljs-string">'source1'</span>,<span class="hljs-comment">//指定此图层使用数据源source1</span><br>            <span class="hljs-comment">//下面是图层的样式信息</span><br>            <span class="hljs-string">"type"</span>: <span class="hljs-string">"circle"</span>,<span class="hljs-comment">//样式类型为圆点</span><br>            <span class="hljs-string">"paint"</span>: &#123;<br>                <span class="hljs-string">"circle-color"</span>: <span class="hljs-string">"#FF0000"</span>,<span class="hljs-comment">//颜色</span><br>                <span class="hljs-string">"circle-radius"</span>: <span class="hljs-number">20</span><span class="hljs-comment">//圆点半径</span><br>            &#125;<br>        &#125;);<br>    &#125;);<br></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><strong>注释1:</strong><br>mapbox提供多种类型的source，这里我们选择了最容易理解的geojson source，其它的类型我们将在后续章节中见到</p><p><strong>注释2:</strong><br>data里传入了一个特殊格式json，这种格式的json我们称为geojson，它以指定的格式描述了要素的属性和形状，有关geojson的详细信息，我们将在下一章描述</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mapbox-gl教程(1):初识mapboxgl</title>
    <link href="/2020/12/21/2020-12-21-mapbox-gl-tutorial-1/"/>
    <url>/2020/12/21/2020-12-21-mapbox-gl-tutorial-1/</url>
    
    <content type="html"><![CDATA[<h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h1><p>我们先来编写一个hello world，并看看效果：</p><div>    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet' />    <div id='map' style='width: 90%; height: 300px;'></div>    <script>        mapboxgl.accessToken = 'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA';        var map = new mapboxgl.Map({            container: 'map',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.403119,39.925338],            zoom: 9        });    </script></div><p>代码如下（html、body之类的标签就省略了哈）：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css'</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'stylesheet'</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'map'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width: 90%; height: 300px;'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript"><br>    mapboxgl.accessToken = <span class="hljs-string">'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA'</span>;<br>    <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>        container: <span class="hljs-string">'map'</span>,<br>        style: <span class="hljs-string">'mapbox://styles/mapbox/streets-v9'</span>,<br>        center: [<span class="hljs-number">116.403119</span>,<span class="hljs-number">39.925338</span>],<br>        zoom: <span class="hljs-number">9</span><br>    &#125;);<br></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>逐行解释一下：</p><p>第一步，引入mapbox的js和css</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css'</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'stylesheet'</span> /&gt;</span><br></code></pre></div></td></tr></table></figure><p>第二步，写一个div来展现地图，给它指定id</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'map'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width: 90%; height: 300px;'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>第三步，mapbox设置一个token才能获取它官方发布的地图，这里用了一个公开的token，你也可以去<a href="https://account.mapbox.com/access-tokens/" target="_blank" rel="noopener">这里</a>自己申请一个</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">mapboxgl.accessToken = <span class="hljs-string">'pk.eyJ1IjoiY29kaW5nbWlhbyIsImEiOiJjanh4MjlvNHMwaXppM2NvOGMwdTdkYnluIn0.hXPTIwtl5lj8ro49e3rInA'</span>;<br></code></pre></div></td></tr></table></figure><p>接下来就是传入参数来构造map对象了:</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>    <span class="hljs-attr">container</span>: <span class="hljs-string">'map'</span>,<br>    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.403119</span>,<span class="hljs-number">39.925338</span>],<br>    <span class="hljs-attr">zoom</span>: <span class="hljs-number">9</span>,<br>    <span class="hljs-attr">style</span>: <span class="hljs-string">'mapbox://styles/mapbox/streets-v9'</span>,<br><br>&#125;);<br></code></pre></div></td></tr></table></figure><p>各参数说明如下:</p><table><thead><tr><th>参数名</th><th>解释</th></tr></thead><tbody><tr><td>container</td><td>将地图在指定的dom中展示，这里展示在我们刚才写的id为”map”的div里</td></tr><tr><td>center</td><td>地图初始化时的中心坐标，如果你不知道你要展示的位置的坐标，可以从<a href="http://api.map.baidu.com/lbsapi/getpoint/index.html" target="_blank" rel="noopener">这里</a>点选获取</td></tr><tr><td>zoom</td><td>地图初始化时的缩放等级，越大则越比例尺越大</td></tr><tr><td>style</td><td>地图样式，详见下面的描述</td></tr></tbody></table><h2 id="style"><a href="#style" class="headerlink" title="style"></a>style</h2><p>mapbox的style是一个比较奇怪的概念，与arcgis、openlayers等产品中的样式有很大的不同，它实际上是数据源、图层、样式等信息的汇总。<br>我们后面再详细地学习它，这里我们只需知道它是一个url或者json，配置了地图展现相关的重要信息。所以，配置不同的style会在地图上展现出不同的数据和式样。</p><p>本节中我们仅学习通过url来展现mapbox官方提供的背景地图。</p><p>下面列出了几种常用的style id，你可以预览并选择一个你喜欢的id，然后用’mapbox://styles/mapbox/‘+id来配置它们</p><div>    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'></script>    <div id="menu">        <input id="streets-v9" type="radio" name="rtoggle" value="streets" checked="checked"/><label>streets-v9</label>&nbsp;        <input id="outdoors-v10" type="radio" name="rtoggle" value="light" /><label>outdoors-v10</label>&nbsp;        <input id="dark-v9" type="radio" name="rtoggle" value="light" /><label>dark-v9</label>&nbsp;        <input id="light-v9" type="radio" name="rtoggle" value="light" /><label>light-v9</label>&nbsp;        <input id="satellite-streets-v9" type="radio" name="rtoggle" value="light" /><label>satellite-streets-v9</label>&nbsp;        <input id="traffic-day-v2" type="radio" name="rtoggle" value="light" /><label>traffic-day-v2</label>&nbsp;        <input id="traffic-night-v2" type="radio" name="rtoggle" value="light" /><label>traffic-night-v2</label>&nbsp;    </div>    <div id='map1' style='width: 90%; height: 300px;'></div>    <script>        var map1 = new mapboxgl.Map({            container: 'map1',            style: 'mapbox://styles/mapbox/streets-v9',            center: [116.403119,39.925338],            zoom: 9        });        mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.0/mapbox-gl-rtl-text.js');        var languageControl = new MapboxLanguage({            defaultLanguage: 'zh'        });        map1.addControl(languageControl);        var layerList = document.getElementById('menu');        var inputs = layerList.getElementsByTagName('input');        function switchLayer(layer) {            var layerId = layer.target.id;            map1.setStyle('mapbox://styles/mapbox/' + layerId);            map1.removeControl(languageControl);            map1.addControl(languageControl);        }        for (var i = 0; i < inputs.length; i++) {            inputs[i].onclick = switchLayer;        }    </script></div><br/><p>更多的样式，你可以从<a href="https://www.mapbox.com/gallery/" target="_blank" rel="noopener">这里找到</a>，然后申请一个token并点击“Expoler”-&gt;“Add Decimal  to your account”将其复制到你的token下来使用</p><p>当然，这种style的设置方式虽然便捷，但是太不灵活了，后续的章节中我们将使用自定义json来配置它</p><h1 id="mapbox-gl的优势和劣势"><a href="#mapbox-gl的优势和劣势" class="headerlink" title="mapbox-gl的优势和劣势"></a>mapbox-gl的优势和劣势</h1><p>如果你用过openlayers、leaflet或是arcgis js，你会发现mapbox-gl构建map对象的语法和它们很相像。事实上，如果我们想做一个web端的二维gis应用，这几款框架也是仅有的比较靠谱的选择。</p><p>arcgis js作为esri的产品，功能强大稳定，而且它是require风格编写的，按需加载的机制使我们不用担心文件体积爆炸。但一个很致命的问题是，它不开源，使得深度调试和扩展很是麻烦。</p><p>leaflet的优势是轻量级和对ie等浏览器的良好兼容，如果你需要兼容ie或是做一些轻量级、小数据量的开发，leaflet是不错的选择。</p><p>openlayers是对面向对象开发人员非常友好的一个框架，map、layer、feature、geometry的分层非常清晰，写起来非常的OOP，如果有很复杂的前端逻辑，openlayers写出来的代码比其它几个都容易维护。<br>缺点是性能一般，而且对于一些新技术有少量奇怪的bug，比如矢量瓦片绘制跨瓦片的点绘制不完整。</p><p>还有一类是运营商开发的框架，比如百度和高德，这类框架优势是方便且中文文档丰富。但是必须接公网、不开源、定制性差等问题，使得我们在需要开发强业务功能时几乎不会去考虑它。</p><p>那么，mapbox有哪些优劣呢？最大的优劣都来源于：<strong>mapbox-gl是基于webgl开发的</strong>。</p><p>👍<strong>高性能</strong> 用js进行数据基本处理，然后就丢给webgl去渲染了，所以性能非常强悍。以我的破笔记本来测试geojson点图层的加载，<br>openlayers加载一千个点左右就开始卡顿了，而mapbox可以支撑两万个点左右。如果用mapbox的webgl接口来操作，甚至可以支撑到百万级。</p><p>👍<strong>可视化效果丰富</strong> mapbox-gl开放了webgl的操作接口，这使得我们可以直接用gl对象或是将gl对象丢给Three.js等框架，从而做出炫酷的效果。</p><p>👎<strong>代码层级不够清晰</strong> 但基于webgl开发，造成了数据与渲染的高度分离，使得mapbox的代码层次不是很清晰，甚至于根本就没有feature和geometry（而是用json去代替），不是很容易维护，后面的章节中我们会体会到这点。<br>所以开发之前，你应该充分设计代码结构以防止后期的混乱（当然，openlayers虽然层次清晰，但不好好设计依然会混乱，只是比mapbox容易维护一些）。</p><p>👎<strong>兼容性不高</strong> 在IE上完全无法展示，但微软自己都把IE丢掉了，除了应付守旧的用户，这条也不是大问题。</p><p>了解了以上优劣，相信你会对你的的项目是否该使用mapbox有自己的判断。</p><h1 id="本教程计划章节"><a href="#本教程计划章节" class="headerlink" title="本教程计划章节"></a>本教程计划章节</h1><p>本教程将按以下章节，逐步介绍和学习mapbox（啊，这坑好大，慢慢施工<del>~</del>）</p><h2 id="第一部分-简介"><a href="#第一部分-简介" class="headerlink" title="第一部分 简介"></a>第一部分 简介</h2><p>这部分我们先编写一个hello world，介绍mapbox的基本情况，并与其它前端地图框架做比较，以帮助你快速选型和上手</p><p><a href="/2020/12/21/2020-12-21-mapbox-gl-tutorial-1">mapbox-gl教程(1):初识mapboxgl</a></p><h2 id="第二部分-简单的数据加载与展现"><a href="#第二部分-简单的数据加载与展现" class="headerlink" title="第二部分 简单的数据加载与展现"></a>第二部分 简单的数据加载与展现</h2><p>完成了hello world，我们就可以在此基础上展现我们自己的数据，从而实现实际的业务功能了</p><p><a href="/2020/12/25/2020-12-25-mapbox-gl-tutorial-2">mapbox-gl教程(2):添加自定义数据（小数据量的方式）(上)</a><br>介绍如何将自定义数据添加到地图上，并按我们需要的样式进行展现</p><p><a href="/2020/12/28/2020-12-28-mapbox-gl-tutorial-3"> mapbox-gl教程(3):添加自定义数据（小数据量的方式）(下)</a><br>详细介绍geojson数据源</p><p><a href="/2020/12/29/2020-12-29-mapbox-gl-tutorial-4/">mapbox-gl教程(4):适配国内底图</a><br>mapbox官方的底图对国内用户并不是很友好，这里介绍一些适配方式，适配过程中我们将接触到一种新的数据源:栅格瓦片</p><h2 id="第三部分-地图能力拓展——交互事件、组件及第三方插件"><a href="#第三部分-地图能力拓展——交互事件、组件及第三方插件" class="headerlink" title="第三部分 地图能力拓展——交互事件、组件及第三方插件"></a>第三部分 地图能力拓展——交互事件、组件及第三方插件</h2><p>完成了数据加载后，我们基本具备了地图展现的能力，接下来我们将补充学习如何与地图进行交互，并利用插件</p><p><a href="#/2021/08/23/2021-08-23-mapbox-gl-tutorial-5/">mapbox-gl教程(5):常见事件与组件</a></p><p><a href="#本教程简介">(施工中) mapbox-gl教程(6):通过第三方组件扩展的效果</a></p><h2 id="第四部分-数据与图层"><a href="#第四部分-数据与图层" class="headerlink" title="第四部分 数据与图层"></a>第四部分 数据与图层</h2><p>第二部分已经介绍了如何加载官方地图和自定义数据，然而很多情况下这并不能满足我们的需求。</p><p>例如，在内网环境下我们无法使用官网的底图，那我们需要自己发布和加载内网底图来替换它。</p><p>又如，数据量很大时，用第二部分介绍的添加geojson图层的方式会使得浏览器卡死，此时我们需要一些更高效的方法。</p><p>或是需要高级特效的场景，我们需要使用mapbox的webgl接口来扩展自定义图层。</p><p>这些例子中我们发现，要把gis功能做精，往往是需要前后端技术密切配合的，所以如果你是一位纯前端/后端，有些内容看起来会比较吃力，<br>你需要补习一下相关知识，或者找一位后端/前端来帮助你。</p><p><a href="#本教程简介">(施工中) mapbox-gl教程(7):栅格瓦片图层的发布与使用</a></p><p><a href="#本教程简介">(施工中) mapbox-gl教程(8):矢量瓦片图层的发布与使用</a></p><p><a href="#本教程简介">(施工中) mapbox-gl教程(9):使用webgl接口扩展展现效果</a></p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox-gl教程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java读取arcgis的gdb文件</title>
    <link href="/2020/11/05/2020-11-5-java-read-gdb/"/>
    <url>/2020/11/05/2020-11-5-java-read-gdb/</url>
    
    <content type="html"><![CDATA[<p>gdb,是arcgis重要的数据格式之一，它把矢量数据按以下层级结构存为本地文件</p><figure class="highlight ada"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ada">图层<br><span class="hljs-comment">-- 要素</span><br><span class="hljs-comment">---- 属性</span><br><span class="hljs-comment">---- 形状</span><br><span class="hljs-comment">---- 样式</span><br></code></pre></div></td></tr></table></figure><p>gdal提供了函数允许我们读取gdb，因此，我们可以通过jni调用gdal来再java中读取gdal</p><h1 id="1、配置gdal环境"><a href="#1、配置gdal环境" class="headerlink" title="1、配置gdal环境"></a>1、配置gdal环境</h1><p>liunx下按照gdal需要编译，而windows下就比较简单了，下载编译好的dll文件，然后环境变量path里加入dll目录即可</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">链接：https:<span class="hljs-regexp">//</span>pan.baidu.com<span class="hljs-regexp">/s/</span><span class="hljs-number">1</span>kH3djGQsow-llQiy82068g <br>提取码：uuwn<br></code></pre></div></td></tr></table></figure><h1 id="2、建一个maven工程"><a href="#2、建一个maven工程" class="headerlink" title="2、建一个maven工程"></a>2、建一个maven工程</h1><p>前面下载的那个包里的lib文件夹拷到工程中，然后maven里添加gdal的依赖:</p><figure class="highlight dust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dust"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.gdal<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gdal<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>system<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;systemPath&gt;$</span></span><span class="hljs-template-variable">&#123;project.basedir&#125;</span><span class="xml"><span class="hljs-comment">/lib/gdal-centos7x64.jar&lt;/systemPath&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">systemPath</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;project.basedir&#125;</span><span class="xml">/lib/gdal-win64.jar<span class="hljs-tag">&lt;/<span class="hljs-name">systemPath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br></code></pre></div></td></tr></table></figure><h1 id="3、写代码"><a href="#3、写代码" class="headerlink" title="3、写代码"></a>3、写代码</h1><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com;<br><br><span class="hljs-keyword">import</span> org.gdal.gdal.gdal;<br><span class="hljs-keyword">import</span> org.gdal.ogr.*;<br><br><span class="hljs-keyword">import</span> java.sql.Date;<br><span class="hljs-keyword">import</span> java.sql.Time;<br><span class="hljs-keyword">import</span> java.sql.Timestamp;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><br><span class="hljs-comment">/**<br> * gdal读取gdb示例<br> * <span class="hljs-doctag">@author</span> liuyu<br> * <span class="hljs-doctag">@date</span> 2020/11/5<br> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        gdal.AllRegister();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Driver driver = ogr.GetDriverByName(<span class="hljs-string">"OpenFileGDB"</span>);<br>        DataSource dataSource = driver.Open(<span class="hljs-string">"D:\\data\\云南省矢量地图gdb\\云南省地图综合成果.gdb"</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; dataSource.GetLayerCount(); i++) &#123;<br>            <span class="hljs-comment">//获取图层</span><br>            Layer layer = dataSource.GetLayer(i);<br>            System.out.println(i + <span class="hljs-string">"\t"</span> + layer.GetName());<br>            <span class="hljs-keyword">do</span> &#123;<span class="hljs-comment">//获取图层下的要素</span><br>                Feature feature = layer.GetNextFeature();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == feature) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">//获取样式，这里是空，待确定</span><br>                System.out.println(feature.GetStyleString());<br>                <span class="hljs-comment">//获取geometry</span><br>                System.out.println(feature.GetGeometryRef().ExportToWkt());<span class="hljs-comment">//也可以ExportToWkb() gml等等</span><br>                <span class="hljs-comment">//获取属性</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> p = <span class="hljs-number">0</span>; p &lt; feature.GetFieldCount(); p++) &#123;<br>                    System.out.println(feature.GetFieldDefnRef(p).GetName()<br>                            + <span class="hljs-string">"\t"</span> +<br>                            getProperty(feature, p));<br>                &#125;<br>                System.out.println(<span class="hljs-string">"---------"</span>);<br>            &#125; <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">getProperty</span><span class="hljs-params">(Feature feature, <span class="hljs-keyword">int</span> index)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> type = feature.GetFieldType(index);<br>        PropertyGetter propertyGetter;<br>        <span class="hljs-keyword">if</span> (type &lt; <span class="hljs-number">0</span> || type &gt;= propertyGetters.length) &#123;<br>            propertyGetter = stringPropertyGetter;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            propertyGetter = propertyGetters[type];<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> propertyGetter.get(feature, index);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**<br>     * 属性获取器<br>     */</span><br>    <span class="hljs-meta">@FunctionalInterface</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PropertyGetter</span> </span>&#123;<br>        <span class="hljs-function">Object <span class="hljs-title">get</span><span class="hljs-params">(Feature feature, <span class="hljs-keyword">int</span> index)</span></span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> PropertyGetter stringPropertyGetter = (feature, index) -&gt; feature.GetFieldAsString(index);<br><br>    <span class="hljs-comment">/**<br>     * feature.GetFieldType(index)得到一个属性类型的int值,该值对应具体类型<br>     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> PropertyGetter[] propertyGetters = <span class="hljs-keyword">new</span> PropertyGetter[]&#123;<br>            (feature, index) -&gt; feature.GetFieldAsInteger(index),<span class="hljs-comment">//0Integer</span><br>            (feature, index) -&gt; feature.GetFieldAsIntegerList(index),<span class="hljs-comment">//1IntegerList</span><br>            (feature, index) -&gt; feature.GetFieldAsDouble(index),<span class="hljs-comment">//2Real</span><br>            (feature, index) -&gt; feature.GetFieldAsDoubleList(index),<span class="hljs-comment">//3RealList</span><br>            stringPropertyGetter,<span class="hljs-comment">//4String</span><br>            (feature, index) -&gt; feature.GetFieldAsStringList(index),<span class="hljs-comment">//5StringList</span><br>            stringPropertyGetter,<span class="hljs-comment">//6(unknown)</span><br>            stringPropertyGetter,<span class="hljs-comment">//7(unknown)</span><br>            (feature, index) -&gt; feature.GetFieldAsBinary(index),<span class="hljs-comment">//8Binary</span><br>            (feature, index) -&gt; &#123;<br>                <span class="hljs-keyword">int</span>[] pnYear = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMonth = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnDay = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnHour = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMinute = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">float</span>[] pfSecond = <span class="hljs-keyword">new</span> <span class="hljs-keyword">float</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnTZFlag = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                feature.GetFieldAsDateTime(index, pnYear, pnMonth, pnDay, pnHour, pnMinute, pfSecond, pnTZFlag);<br>                Date date = Date.valueOf(LocalDate.of(pnYear[<span class="hljs-number">0</span>], pnMonth[<span class="hljs-number">0</span>], pnDay[<span class="hljs-number">0</span>]));<br>                <span class="hljs-keyword">return</span> date;<br>            &#125;,<span class="hljs-comment">//9Date</span><br>            (feature, index) -&gt; &#123;<br>                <span class="hljs-keyword">int</span>[] pnYear = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMonth = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnDay = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnHour = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMinute = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">float</span>[] pfSecond = <span class="hljs-keyword">new</span> <span class="hljs-keyword">float</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnTZFlag = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                feature.GetFieldAsDateTime(index, pnYear, pnMonth, pnDay, pnHour, pnMinute, pfSecond, pnTZFlag);<br>                <span class="hljs-keyword">float</span> fSecond = pfSecond[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">int</span> s = (<span class="hljs-keyword">int</span>) fSecond;<br>                <span class="hljs-keyword">int</span> ns = (<span class="hljs-keyword">int</span>) (<span class="hljs-number">1000000000</span> * fSecond - s);<br>                Time time = Time.valueOf(LocalTime.of(pnHour[<span class="hljs-number">0</span>], pnMinute[<span class="hljs-number">0</span>], s, ns));<br>                <span class="hljs-keyword">return</span> time;<br>            &#125;,<span class="hljs-comment">// 10Time</span><br>            (feature, index) -&gt; &#123;<br>                <span class="hljs-keyword">int</span>[] pnYear = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMonth = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnDay = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnHour = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnMinute = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">float</span>[] pfSecond = <span class="hljs-keyword">new</span> <span class="hljs-keyword">float</span>[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">int</span>[] pnTZFlag = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1</span>];<br>                feature.GetFieldAsDateTime(index, pnYear, pnMonth, pnDay, pnHour, pnMinute, pfSecond, pnTZFlag);<br>                <span class="hljs-keyword">float</span> fSecond = pfSecond[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">int</span> s = (<span class="hljs-keyword">int</span>) fSecond;<br>                <span class="hljs-keyword">int</span> ns = (<span class="hljs-keyword">int</span>) (<span class="hljs-number">1000000000</span> * fSecond - s);<br>                LocalDateTime localDateTime = LocalDateTime.of(<br>                        LocalDate.of(pnYear[<span class="hljs-number">0</span>], pnMonth[<span class="hljs-number">0</span>], pnDay[<span class="hljs-number">0</span>]),<br>                        LocalTime.of(pnHour[<span class="hljs-number">0</span>], pnMinute[<span class="hljs-number">0</span>], s, ns)<br>                );<br>                Timestamp timestamp = Timestamp.valueOf(localDateTime);<br>                <span class="hljs-keyword">return</span> timestamp;<br>            &#125;,<span class="hljs-comment">//11DateTime</span><br>            (feature, index) -&gt; feature.GetFieldAsInteger64(index),<span class="hljs-comment">//12Integer64</span><br>            (feature, index) -&gt; feature.GetFieldAsIntegerList(index),<span class="hljs-comment">//13 Integer64List</span><br>            <span class="hljs-comment">//&gt;=14(unknown)</span><br>    &#125;;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>服务端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>arcgis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>干掉mapbox里的雪碧图(sprite)</title>
    <link href="/2020/09/25/2020-09-25-kill-the-sprite/"/>
    <url>/2020/09/25/2020-09-25-kill-the-sprite/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是雪碧图"><a href="#什么是雪碧图" class="headerlink" title="什么是雪碧图"></a>什么是雪碧图</h1><p>雪碧图源于前端的小图标展现技术，将小图标和背景图像合并到一张图片上，然后利用css的背景定位来显示需要显示的图片部分。<br>对于含有大量小图标的页面，雪碧图把多个图片请求合并成了一个，大幅提高了加载性能。<br><img src="/myimgs/20200925/1.jpg" alt="雪碧图"></p><p>mapbox中也采用了类似的思想：当我们配置了多个symbol类型的图层时，为了减少图标的请求数，mapbox也提供了雪碧图的加载方式</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> mapboxgl.Map(&#123;<br>    <span class="hljs-attr">container</span>: <span class="hljs-string">'map'</span>,<br>    <span class="hljs-attr">style</span>: &#123;<br>        <span class="hljs-string">"version"</span>: <span class="hljs-number">8</span>,<br>        <span class="hljs-string">"sources"</span>: &#123;&#125;,<br>        <span class="hljs-string">"layers"</span>: [],<br>        <span class="hljs-string">"sprite"</span>: baseUrl + <span class="hljs-string">"/assets/sprites/mysprites"</span>,<span class="hljs-comment">//配置一个雪碧图的url路径</span><br>    &#125;,<br>    <span class="hljs-comment">//...</span><br>&#125;);<br></code></pre></div></td></tr></table></figure><p>配置了sprite字段后，mapbox就会去加载雪碧图png和一个json配置：</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"icon1"</span>: &#123;<br>    <span class="hljs-attr">"x"</span>: <span class="hljs-number">324</span>,<br>    <span class="hljs-attr">"y"</span>: <span class="hljs-number">308</span>,<br>    <span class="hljs-attr">"width"</span>: <span class="hljs-number">20</span>,<br>    <span class="hljs-attr">"height"</span>: <span class="hljs-number">11</span>,<br>    <span class="hljs-attr">"pixelRatio"</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">"sdf"</span>: <span class="hljs-literal">false</span><br>  &#125;,<br>  <span class="hljs-attr">"icon2"</span>: &#123;<br>    <span class="hljs-attr">"x"</span>: <span class="hljs-number">221</span>,<br>    <span class="hljs-attr">"y"</span>: <span class="hljs-number">464</span>,<br>    <span class="hljs-attr">"width"</span>: <span class="hljs-number">15</span>,<br>    <span class="hljs-attr">"height"</span>: <span class="hljs-number">15</span>,<br>    <span class="hljs-attr">"pixelRatio"</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">"sdf"</span>: <span class="hljs-literal">false</span><br>  &#125;,<br>  <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>随后，我们就可以在图层中使用这个图标了:</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js">map.addLayer(<br>            &#123;<br>                <span class="hljs-string">"id"</span>: <span class="hljs-string">"mylayer"</span>,<br>                <span class="hljs-string">"type"</span>: <span class="hljs-string">"symbol"</span>,<br>                <span class="hljs-string">"source"</span>: <span class="hljs-string">"mysource"</span>,<br>                <span class="hljs-string">"source-layer"</span>: <span class="hljs-string">"mylayersource"</span>,<br>                <span class="hljs-string">"layout"</span>: &#123;<br>                    <span class="hljs-string">"icon-image"</span>: <span class="hljs-string">"icon1"</span>,<br>                &#125;<br>            &#125;<br><br>)<br></code></pre></div></td></tr></table></figure><h1 id="用雪碧图来配图标的缺点"><a href="#用雪碧图来配图标的缺点" class="headerlink" title="用雪碧图来配图标的缺点"></a>用雪碧图来配图标的缺点</h1><p>想在雪碧图上改图标就不那么容易，尤其是我这种大老粗的程序员，还要买杯奶茶去劳烦美工妹子帮忙。<br>嗯，当然也可以写段代码去修改它，或者直接找一些相关的开源工具来解决。</p><p>然而，矢量瓦片的一大卖点就是用户可以在前端自由定制样式，要去修改图片这个操作一定程度上限制了矢量瓦片样式的灵活性。</p><p>同时，目前mapbox仅支持传入一张雪碧图，假如用户自己的图层也配了一份雪碧图，那还需要把两个雪碧图合起来，也就是说图层的自由组合也受到了限制、</p><h1 id="用单个图标来替代雪碧图"><a href="#用单个图标来替代雪碧图" class="headerlink" title="用单个图标来替代雪碧图"></a>用单个图标来替代雪碧图</h1><h2 id="单个图标的使用"><a href="#单个图标的使用" class="headerlink" title="单个图标的使用"></a>单个图标的使用</h2><p>基于上述问题，在更灵活的样式配置的场景下，使用单个图标比雪碧图整合要方便的多：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">let</span> url = <span class="hljs-string">'http://xxx.png'</span><br><span class="hljs-keyword">let</span> iconId = <span class="hljs-string">'icon1'</span><br>map.loadImage(url, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, img</span>) </span>&#123;<br>            <span class="hljs-keyword">if</span> (map.hasImage(iconId)) &#123;<br>                map.updateImage(iconId, img)<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                map.addImage(iconId, img)<br>            &#125;<br>            map.addLayer(&#123;<br>                                         <span class="hljs-string">"id"</span>: <span class="hljs-string">"mylayer"</span>,<br>                                         <span class="hljs-string">"type"</span>: <span class="hljs-string">"symbol"</span>,<br>                                         <span class="hljs-string">"source"</span>: <span class="hljs-string">"mysource"</span>,<br>                                         <span class="hljs-string">"source-layer"</span>: <span class="hljs-string">"mylayersource"</span>,<br>                                         <span class="hljs-string">"layout"</span>: &#123;<br>                                             <span class="hljs-string">"icon-image"</span>: iconId,<br>                                         &#125;<br>            &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>需要更换/新增图标时，只要改一下图标url之类的代码即可。</p><h2 id="解决单个图标加载的性能问题"><a href="#解决单个图标加载的性能问题" class="headerlink" title="解决单个图标加载的性能问题"></a>解决单个图标加载的性能问题</h2><p>前面提到，使用雪碧图是为了减少图片请求数量从而提高加载性能，当图标数量很多时，我们传多个url去请求图片就不合适了。</p><p>幸好loadImage函数传入的url允许是一个base64字符串，例如:</p><figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">data:image/png;base64,R0lGODlhHAAmAKIHA<span class="hljs-built_in">..</span>.<span class="hljs-attribute">f394uLiwAAAP</span>===<br></code></pre></div></td></tr></table></figure><p>于是，我们可以编写一个服务，批量传入图标id，批量返回图标base64字符串，从而将多个请求合并为一个</p><figure class="highlight vala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vala"><span class="hljs-meta">#请求url</span><br>http:<span class="hljs-comment">//xxx/getIcons?id=icon1,icon2</span><br><br><span class="hljs-meta">#返回数据</span><br>&#123;<br>    icon1:<span class="hljs-string">'data:image/png;base64,R0lGODlhHAAmAKIHA...f394uLiwAAAP==='</span>,<br>    icon2:<span class="hljs-string">'yH5B…EoqQqJKT1TRk1V7S2xYJADs='</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>然后，再编写一段对应的前端加载函数即可：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-comment">/**<br> * 从自定义服务批量加载图片<br> * <span class="hljs-doctag">@param <span class="hljs-variable">map</span></span><br> * <span class="hljs-doctag">@param <span class="hljs-variable">ids</span></span><br> * <span class="hljs-doctag">@param <span class="hljs-variable">cb</span></span><br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadBatch</span>(<span class="hljs-params">map, ids, cb</span>) </span>&#123;<br>    <span class="hljs-keyword">let</span> uuids = <span class="hljs-string">''</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> iconId <span class="hljs-keyword">in</span> ids) &#123;<br>        <span class="hljs-keyword">const</span> uuid = ids[iconId];<br>        uuids += uuid + <span class="hljs-string">','</span><br>    &#125;<br>    $.ajax(&#123;<br>        <span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,<br>        <span class="hljs-attr">url</span>: <span class="hljs-string">"http://xxx/getIcons"</span>,<br>        <span class="hljs-attr">data</span>: &#123;<span class="hljs-attr">ids</span>: uuids&#125;,<br>        <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">dataType</span>: <span class="hljs-string">'json'</span>,<br>        <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">json</span>) </span>&#123;<span class="hljs-comment">//获取数据</span><br>            <span class="hljs-keyword">const</span> notFinds = [];<br>            <span class="hljs-keyword">const</span> urls = &#123;&#125;;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> iconId <span class="hljs-keyword">in</span> ids) &#123;<br>                <span class="hljs-keyword">const</span> uuid = ids[iconId];<br>                <span class="hljs-keyword">const</span> base64 = json[uuid]<br>                <span class="hljs-keyword">if</span> (!base64) &#123;<br>                    notFinds.push(iconId)<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    urls[iconId] = base64<br>                &#125;<br>            &#125;<br>            loadFromUrls(map, urls, cb)<br>        &#125;<br><br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">/**<br> * 批量加载url图片<br> * <span class="hljs-doctag">@param <span class="hljs-variable">map</span></span><br> * <span class="hljs-doctag">@param </span>urls 请求urls &#123;&lt;id1&gt;:&lt;url1&gt;,&lt;id2&gt;:&lt;url2&gt;,...&#125;<br> * <span class="hljs-doctag">@param </span>cb 回调函数 &#123;imgs:&#123;&#125;,errs:&#123;&#125;&#125;<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadFromUrls</span>(<span class="hljs-params">map, urls, cb</span>) </span>&#123;<br>    <span class="hljs-keyword">const</span> res = &#123;<br>        <span class="hljs-attr">imgs</span>: &#123;&#125;,<br>        <span class="hljs-attr">errs</span>: &#123;&#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> num = <span class="hljs-built_in">Object</span>.keys(urls).length<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doReturn</span>(<span class="hljs-params"></span>) </span>&#123;<br>        num--;<br>        <span class="hljs-keyword">if</span> (num == <span class="hljs-number">0</span>) &#123;<br>            cb(res)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subCb</span>(<span class="hljs-params">iconId, img</span>) </span>&#123;<br>        res.imgs[iconId] = img;<br>        doReturn();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subErrCb</span>(<span class="hljs-params">iconId, err</span>) </span>&#123;<br>        res.errs[iconId] = err;<br>        doReturn();<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> iconId <span class="hljs-keyword">in</span> urls) &#123;<br>        <span class="hljs-keyword">const</span> url = urls[iconId];<br>        loadFromUrl(map, iconId, url, subCb, subErrCb)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**<br> * 加载url<br> * <span class="hljs-doctag">@param <span class="hljs-variable">map</span></span><br> * <span class="hljs-doctag">@param </span>iconId 图标id<br> * <span class="hljs-doctag">@param </span>url url 可以是base64url<br> * <span class="hljs-doctag">@param </span>cb 加载成功回调<br> * <span class="hljs-doctag">@param </span>errCb 加载错误回调<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadFromUrl</span>(<span class="hljs-params">map, iconId, url, cb, errCb</span>) </span>&#123;<br>    map.loadImage(url, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, img</span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (err) &#123;<br>            <span class="hljs-keyword">if</span> (errCb) &#123;<br>                errCb(iconId, err)<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> err<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (map.hasImage(iconId)) &#123;<br>            map.updateImage(iconId, img)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            map.addImage(iconId, img)<br>        &#125;<br>        cb(iconId, img)<br>    &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽然当下的web开发讲究前后端分离，<br>但是从雪碧图的这个例子可以看出，作为一个giser，在主修前端or后端的一方时，还是要多去同时了解下前后端的知识，才能设计出更高效、灵活的方案。</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mapbox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>neo4j同时使用嵌入模式和服务模式</title>
    <link href="/2019/12/27/2019-12-27-custom-neo4j1/"/>
    <url>/2019/12/27/2019-12-27-custom-neo4j1/</url>
    
    <content type="html"><![CDATA[<p>neo4j(社区版)有两种模式:嵌入模式和服务器模式，下图描述了它们的使用区别，简单来说，嵌入模式就是直接用java代码去操作，服务器模式就是通过暴露出来的web端口传入查询语句等进行操作。<br><img src="/myimgs/20191227/1.jpg" alt="嵌入模式与服务器模式对比"></p><p>两种模式哪种更优？网上有太多的帖子讨论这个。可是，毕竟只有小孩子才做选择题，我们为什么不选择全都要呢O(∩_∩)O</p><p>话不多说，直接上代码</p><p>1、引入maven依赖:</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.neo4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>neo4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.neo4j.app<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>neo4j-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>2、拷贝一个neo4j.conf文件，按官方文档进行自己需要的配置，值得注意的是此处:</p><figure class="highlight haskell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs haskell"><span class="hljs-meta">#数据文件存放位置</span><br><span class="hljs-title">dbms</span>.directories.<span class="hljs-class"><span class="hljs-keyword">data</span>=<span class="hljs-type">D</span>:/<span class="hljs-keyword">data</span>/test</span><br></code></pre></div></td></tr></table></figure><p>3、编写初始化代码</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static final ServerBootstrapper serverBootstrapper;<br><span class="hljs-keyword">private</span> static final String dbPath;<br><span class="hljs-keyword">private</span> static final GraphDatabaseService graphDb;<span class="hljs-operator"><br>...<br>    </span><span class="hljs-comment">//读neo4j.conf的配置</span><br>    Properties p = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Properties()</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        p.load(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ResourcesReader</span>.</span></span>read<span class="hljs-constructor">Stream(Neo4jDbManager.<span class="hljs-params">class</span>, <span class="hljs-string">"neo4j.conf"</span>)</span>);<br>    &#125; catch (IOException e) &#123;<br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">RuntimeException(<span class="hljs-params">e</span>)</span>;<br>    &#125;<br><br>    dbPath = p.get<span class="hljs-constructor">Property(<span class="hljs-string">"dbms.directories.data"</span>)</span>;<br><br>    File storeDir = <span class="hljs-keyword">new</span> <span class="hljs-constructor">File(<span class="hljs-params">dbPath</span>)</span>;<br><br>    serverBootstrapper = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CommunityBootstrapper()</span>;<br>    String cfgFilePath = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ResourcesReader</span>.</span></span>get<span class="hljs-constructor">ClassRootPath(Neo4jDbManager.<span class="hljs-params">class</span>)</span> +<br>            <span class="hljs-string">"/neo4j.conf"</span>;<br>    <span class="hljs-comment">//社区版的bug，部分属性无法直接从配置文件写入(例如7474端口号)，手动覆盖一下</span><br>    Optional&lt;File&gt; cfgFile = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Optional</span>.</span></span><span class="hljs-keyword">of</span>(<span class="hljs-keyword">new</span> <span class="hljs-constructor">File(<span class="hljs-params">cfgFilePath</span>)</span>);<br>    Set&lt;String&gt;  cfgKeys = p.<span class="hljs-built_in">string</span><span class="hljs-constructor">PropertyNames()</span>;<br>    Map&lt;String, String&gt; configOverrides = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(cfgKeys.size<span class="hljs-literal">()</span>);<br>    for (String cfgKey : cfgKeys) &#123;<span class="hljs-comment">//把所有配置都读到map里，解决默认端口无法修改的问题</span><br>        configOverrides.put(cfgKey, p.get<span class="hljs-constructor">Property(<span class="hljs-params">cfgKey</span>)</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//启动服务端模式</span><br>    serverBootstrapper.start(storeDir, cfgFile, configOverrides);<br>    NeoServer neoServer = serverBootstrapper.get<span class="hljs-constructor">Server()</span>;<br>    <span class="hljs-comment">//获取内嵌模式db对象</span><br>    graphDb = neoServer.get<span class="hljs-constructor">Database()</span>.get<span class="hljs-constructor">Graph()</span>;<br></code></pre></div></td></tr></table></figure><p>其中，ResourcesReader是我自己写的一个工具类，负责从相对路径读取配置文件，要用的话需要引入这个maven，你也可以自己写一个来替换它~</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.wowtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>catframe-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>4、使用服务端模式和内嵌模式<br>当初始化完成后，服务模式已经在neo4j.conf配置的端口启动了，你可以在localhost:7474（默认端口是这个）这个可视化界面打开看到。</p><p>至于内嵌模式，因为前面我们已经拿到db对象了，可以任意利用java api去操作了，比如:</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">Transaction tx = graphDb.<span class="hljs-keyword">begin</span><span class="hljs-constructor">Tx()</span>;<span class="hljs-comment">//记得起事务和关闭事务</span><br><span class="hljs-keyword">try</span> &#123;<br>    graphDb.find<span class="hljs-constructor">Nodes(Label.<span class="hljs-params">label</span>(<span class="hljs-string">"xxx"</span>)</span>,<span class="hljs-string">"name"</span>,<span class="hljs-string">"小明"</span>).for<span class="hljs-constructor">EachRemaining((<span class="hljs-params">node</span>)</span>-&gt;&#123;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(node.get<span class="hljs-constructor">Property(<span class="hljs-string">"age"</span>)</span>);<br>    &#125;);<br>&#125; finally &#123;<br>    tx.close<span class="hljs-literal">()</span>;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>好了，同时享受内嵌模式的高性能和服务端模式的快捷吧~<br>下一节我们将介绍如何把java方法暴露成自定义函数在服务端模式调用，让你将二者结合应用的更得心应手。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
      <category>neo4j</category>
      
    </categories>
    
    
    <tags>
      
      <tag>neo4j扩展开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>neo4j自定义call函数</title>
    <link href="/2019/12/27/2019-12-27-custom-neo4j2/"/>
    <url>/2019/12/27/2019-12-27-custom-neo4j2/</url>
    
    <content type="html"><![CDATA[<p>在上一小节中(<a href="http://blog.wowtools.org/2019/12/27/2019-12-27-custom-neo4j1/">http://blog.wowtools.org/2019/12/27/2019-12-27-custom-neo4j1/</a>)<br>，我们学习了如何同时使用嵌入模式和服务模式。本小节将学习如何扩展自定义的call函数，以满足自定义查询需求。本小节的代码基于上一小节，所以你可能要先把上一节中的示例先写出来并运行起来。</p><h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h1><p>先看效果图，我们自定义了一个函数test.hello，传入一个name参数,在后台拼接字符串并返回两条测试数据。<br>我们执行如下查询语句后，得到对应的结果如下：<br>call test.hello(‘world’)<br><img src="/myimgs/20191227/2.jpg" alt="自定义函数查询效果"></p><p>具体实现步骤是这样的:</p><h2 id="编写Procedure"><a href="#编写Procedure" class="headerlink" title="编写Procedure"></a>编写Procedure</h2><p>首先，我们新建一个Procedure类，编写自定义函数，并通过注解暴露出来:</p><figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-keyword">import</span> org.neo4j.graphdb.GraphDatabaseService;<br><span class="hljs-keyword">import</span> org.neo4j.procedure.Context;<br><span class="hljs-keyword">import</span> org.neo4j.procedure.Description;<br><span class="hljs-keyword">import</span> org.neo4j.procedure.Name;<br><span class="hljs-keyword">import</span> org.neo4j.procedure.Procedure;<br><br><span class="hljs-keyword">import</span> java.util.stream.Stream;<br><br><span class="hljs-comment">/**<br> * 自定义call函数<br> * <span class="hljs-doctag">@author</span> liuyu<br> * <span class="hljs-doctag">@date</span> 2019/12/30<br> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestProcedures</span> </span>&#123;<br>    <span class="hljs-meta">@Context</span><br>    <span class="hljs-keyword">public</span> GraphDatabaseService db;<br><br><br>    <span class="hljs-comment">/**<br>     * 要返回的自定义对象<br>     */</span><br>    <span class="hljs-keyword">public</span> static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloResult</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String name;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Long</span> num;<br><br>        <span class="hljs-keyword">public</span> HelloResult(String name, <span class="hljs-built_in">Long</span> num) &#123;<br>            <span class="hljs-keyword">this</span>.name = name;<br>            <span class="hljs-keyword">this</span>.num = num;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Procedure(<span class="hljs-meta-string">"test.hello"</span>)</span><br>    <span class="hljs-meta">@Description(<span class="hljs-meta-string">"hello world测试"</span>)</span><br>    <span class="hljs-keyword">public</span> Stream&lt;HelloResult&gt; helloWorld(<span class="hljs-meta">@Name(<span class="hljs-meta-string">"name"</span>)</span> String name) &#123;<br>        <span class="hljs-keyword">return</span> Stream.of(new HelloResult(name + <span class="hljs-string">"-1"</span>, <span class="hljs-number">123L</span>), new HelloResult(name + <span class="hljs-string">"-2"</span>, <span class="hljs-number">456L</span>));<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>其中，<code>HelloResult</code>类定义了我们返回的列的类型。<br>方法helloWorld传入name参数，拼接了两个HelloResult对象后，以Stream封装并返回。<br>最后，我们通过@Procedure(“test.hello”)注解，将方法helloWorld映射到test.hello函数上。</p><h2 id="注册Procedure"><a href="#注册Procedure" class="headerlink" title="注册Procedure"></a>注册Procedure</h2><p>再把Procedure类注册给db就行了~</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml"><span class="hljs-comment">/**<br> * 自定义函数注册类<br> * @param db<br> * @param procedure<br> * @throws KernelException<br> */</span><br>public static void register<span class="hljs-constructor">ProceduresAndFunctions(GraphDatabaseService <span class="hljs-params">db</span>, Class&lt;?&gt; <span class="hljs-params">procedure</span>)</span> throws KernelException &#123;<br>    Procedures procedures = ((GraphDatabaseAPI) db).get<span class="hljs-constructor">DependencyResolver()</span>.resolve<span class="hljs-constructor">Dependency(Procedures.<span class="hljs-params">class</span>)</span>;<br>    procedures.register<span class="hljs-constructor">Procedure(<span class="hljs-params">procedure</span>)</span>;<br>    procedures.register<span class="hljs-constructor">Function(<span class="hljs-params">procedure</span>)</span>;<br>&#125;<br><br>    <span class="hljs-comment">//...接上一小节的代码</span><br>    graphDb = neoServer.get<span class="hljs-constructor">Database()</span>.get<span class="hljs-constructor">Graph()</span>;<br>    <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//将TestProcedures注册进来，所有@Procedure注解过的方法都会被注册</span><br>        register<span class="hljs-constructor">ProceduresAndFunctions(<span class="hljs-params">graphDb</span>, TestProcedures.<span class="hljs-params">class</span>)</span>;<br>    &#125; catch (KernelException e) &#123;<br>        e.print<span class="hljs-constructor">StackTrace()</span>;<br>    &#125;<br></code></pre></div></td></tr></table></figure><h1 id="未完待续内容"><a href="#未完待续内容" class="headerlink" title="未完待续内容"></a>未完待续内容</h1><p>1、HelloResult里只支持一些特定类型的属性，假如我们把num改成int型的，注册时会报异常:</p><figure class="highlight vhdl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">org.neo4j.internal.kernel.api.exceptions.ProcedureException: Field `num` <span class="hljs-keyword">in</span> <span class="hljs-keyword">record</span> `HelloResult` cannot be converted <span class="hljs-keyword">to</span> a Neo4j <span class="hljs-keyword">type</span>: Don<span class="hljs-symbol">'t</span> know how <span class="hljs-keyword">to</span> <span class="hljs-keyword">map</span> `int` <span class="hljs-keyword">to</span> the Neo4j <span class="hljs-keyword">Type</span> System.<br>Please refer <span class="hljs-keyword">to</span> <span class="hljs-keyword">to</span> the documentation <span class="hljs-keyword">for</span> full details.<br><span class="hljs-keyword">For</span> your reference, known types are: [<span class="hljs-built_in">boolean</span>, byte[], double, java.lang.<span class="hljs-built_in">Boolean</span>, java.lang.Double, java.lang.Long, java.lang.Number,...<br></code></pre></div></td></tr></table></figure><p>如果需要自定义类型，则需要自行实现</p><p>2、如果需要查询图库并返回node对象，需要修改注解为</p><figure class="highlight delphi"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs delphi">@<span class="hljs-function"><span class="hljs-keyword">Procedure</span><span class="hljs-params">(<br>    value = "test.hello",<br>    mode = Mode.<span class="hljs-keyword">WRITE</span><br>)</span></span><br></code></pre></div></td></tr></table></figure><p>并作对应的代码修改。</p><p>这些内容将在后续章节中说明。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
      <category>neo4j</category>
      
    </categories>
    
    
    <tags>
      
      <tag>neo4j扩展开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dojo报错Uncaught Error: irrationalPath原因及解决</title>
    <link href="/2018/06/07/2018-06-07-Uncaught-Error-irrationalPath/"/>
    <url>/2018/06/07/2018-06-07-Uncaught-Error-irrationalPath/</url>
    
    <content type="html"><![CDATA[<p>最近写了一堆amd风格的js库供其他同事调用，有同事反映说用dojo.js调的时候会报这个错:</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:4</span> <span class="hljs-selector-tag">Uncaught</span> <span class="hljs-selector-tag">Error</span>: <span class="hljs-selector-tag">irrationalPath</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">s</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:4)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">Ea</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:13)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">Ta</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:14)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">Ba</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:15)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">hb</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:21)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:21</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">c</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:4)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">gb</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:21)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">d</span> (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:20)</span><br>    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">HTMLScriptElement</span>.&lt;<span class="hljs-selector-tag">anonymous</span>&gt; (<span class="hljs-selector-tag">init</span><span class="hljs-selector-class">.js</span><span class="hljs-selector-pseudo">:23)</span><br></code></pre></div></td></tr></table></figure><p>排查了好久，终于找到了原因，一句话解释就是../不能调用配置根路径以上的内容。</p><p>详细还原一下出错过程，我提供的js库路径如下</p><figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">xxx.com</span>/<br>    root/<br>        a/<br>            <span class="hljs-built_in">a1</span>.js<br>        <span class="hljs-keyword">b/<br></span>            <span class="hljs-keyword">b1.js</span><br></code></pre></div></td></tr></table></figure><p>a1.js引用了b1.js:</p><figure class="highlight actionscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs actionscript">define([<span class="hljs-string">'../b/b1'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b1)</span> </span>&#123;<br>    b1.xxx()<br></code></pre></div></td></tr></table></figure><p>同事是这样调用的</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> dojoConfig = &#123;<br>    <span class="hljs-attr">parseOnLoad</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">packages</span>: [<br>        &#123;<br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"ext"</span>,<br>            <span class="hljs-string">"location"</span>: <span class="hljs-string">"xxx.com/root/a"</span><br>        &#125;<br>    ]<br>&#125;;<br><br><span class="hljs-built_in">require</span>([<br>        <span class="hljs-string">"ext/a1"</span><br>    ],<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a1</span>) </span>&#123;<br>        a1.ooxx();<br>    &#125;<br>);<br></code></pre></div></td></tr></table></figure><p>出于安全性考虑，dojo只允许调用根路径(xxx.com/root/a)下的资源,a.js中通过../去引用xxx.com/root/b/b.js，所以就出错了。</p><p>正确地姿势应该是这样:</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> dojoConfig = &#123;<br>    <span class="hljs-attr">parseOnLoad</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">packages</span>: [<br>        &#123;<br>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"ext"</span>,<br>            <span class="hljs-string">"location"</span>: <span class="hljs-string">"xxx.com/root"</span><br>        &#125;<br>    ]<br>&#125;;<br><br><span class="hljs-built_in">require</span>([<br>        <span class="hljs-string">"ext/a/a1"</span><br>    ],<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a1</span>) </span>&#123;<br>        a1.ooxx();<br>    &#125;<br>);<br></code></pre></div></td></tr></table></figure><p>完o(<em>￣︶￣</em>)o</p>]]></content>
    
    
    <categories>
      
      <category>奇葩问题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>dojo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>centos 7安装gdal</title>
    <link href="/2018/05/18/2018-05-18-centos7-install-gdal/"/>
    <url>/2018/05/18/2018-05-18-centos7-install-gdal/</url>
    
    <content type="html"><![CDATA[<p>gdal操作tiff的性能，要比geotools快很多。<br>想要在java中使用gdal，windows可以直接下载到编译好的dll文件(<a href="http://trac.osgeo.org/gdal/wiki/DownloadingGdalBinaries" target="_blank" rel="noopener">点这里下载</a>)，并把存放dll的文件夹配置到path环境变量里即可，有时需要重启一下ide才能识别到<br>centos下需要自己配置环境和编译<br>下面以centos7上安装2.2.3版本的gdal为例，介绍整个安装过程</p><p><em>参考资料<br><a href="https://www.cnblogs.com/gnool/p/7277474.html" target="_blank" rel="noopener">https://www.cnblogs.com/gnool/p/7277474.html</a><br><a href="https://blog.csdn.net/hqfgiser/article/details/78710856" target="_blank" rel="noopener">https://blog.csdn.net/hqfgiser/article/details/78710856</a></em></p><p>首先，需要下载以下文件，方便起见，已全部上传至网盘:<a href="https://pan.baidu.com/s/1ulNu3QqUKMYUpsbnrIfo0w" target="_blank" rel="noopener">gdal_all_files</a></p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">gdal223</span><span class="hljs-selector-class">.zip</span><br><span class="hljs-selector-tag">geos-3</span><span class="hljs-selector-class">.6</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.bz2</span><br><span class="hljs-selector-tag">hdf-4</span><span class="hljs-selector-class">.2</span><span class="hljs-selector-class">.13</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><span class="hljs-selector-tag">hdf5-1</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><span class="hljs-selector-tag">jpegsrc</span><span class="hljs-selector-class">.v9b</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><span class="hljs-selector-tag">netcdf-c-4</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><span class="hljs-selector-tag">proj-4</span><span class="hljs-selector-class">.9</span><span class="hljs-selector-class">.3</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br><span class="hljs-selector-tag">swig-3</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.12</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span><br></code></pre></div></td></tr></table></figure><h1 id="安装gdal"><a href="#安装gdal" class="headerlink" title="安装gdal"></a>安装gdal</h1><h2 id="1-切换到root用户"><a href="#1-切换到root用户" class="headerlink" title="1.切换到root用户"></a>1.切换到root用户</h2><p>su - root</p><h2 id="2-安装依赖环境"><a href="#2-安装依赖环境" class="headerlink" title="2.安装依赖环境"></a>2.安装依赖环境</h2><p>yum  -y  groupinstall “Development tools”   #这步不成功貌似也没问题-_-</p><p>yum -y install zlib-devel</p><h2 id="3-分别安装上述安装包如下："><a href="#3-分别安装上述安装包如下：" class="headerlink" title="3.分别安装上述安装包如下："></a>3.分别安装上述安装包如下：</h2><h3 id="proj"><a href="#proj" class="headerlink" title="proj"></a>proj</h3><figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">tar -zxvf proj<span class="hljs-number">-4.9</span><span class="hljs-number">.3</span>.tar.gz<br>cd proj<span class="hljs-number">-4.9</span><span class="hljs-number">.3</span><br>./configure<br>make<br>make install<br>cd ..<br></code></pre></div></td></tr></table></figure><p>proj —help 检验安装</p><h3 id="geos"><a href="#geos" class="headerlink" title="geos"></a>geos</h3><figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">tar -zxvf geos<span class="hljs-number">-3.6</span><span class="hljs-number">.2</span>.tar.gz<br>cd geos<span class="hljs-number">-3.6</span><span class="hljs-number">.2</span><br>./configure<br>make<br>make install<br>ldconfig<br>cd ..<br></code></pre></div></td></tr></table></figure><h3 id="jpeg"><a href="#jpeg" class="headerlink" title="jpeg"></a>jpeg</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">tar -zxf jpegsrc.v9b.tar.gz<br><span class="hljs-keyword">cd</span> jpeg-9b/<br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/opt/jpeg</span><br>make <br>make install<br><span class="hljs-keyword">cd</span> <span class="hljs-string">..</span><br></code></pre></div></td></tr></table></figure><h3 id="hdf5"><a href="#hdf5" class="headerlink" title="hdf5"></a>hdf5</h3><figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">tar -zxf hdf5-1.10.1.tar.gz<br>cd hdf5-1.10.1<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">F9X</span>=ifort<br>./configure <span class="hljs-attribute">--prefix</span>=/opt/hdf5 <span class="hljs-attribute">--with-hdf4</span>=/opt/hdf4 <span class="hljs-attribute">--with-jpeg</span>=/opt/jpeg --enable-java --enable-cxx<br>make <br>make install<br>cd <span class="hljs-built_in">..</span><br></code></pre></div></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">tar -zxf hdf-4.2.13.tar.gz<br><span class="hljs-keyword">cd</span> hdf-4.2.13<br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/opt/hdf4</span> <span class="hljs-params">--enable-netcdf</span> <span class="hljs-params">--enable-jpeg</span> <span class="hljs-params">--with-jpeg=/opt/jpeg</span> <span class="hljs-params">--enable-hdf5</span> <span class="hljs-params">--with-hdf5=/opt/hdf5</span> <span class="hljs-params">--enable-shared</span> <span class="hljs-params">--disable-fortran</span> <span class="hljs-params">--enable-java</span><br>make<br>make install<br><span class="hljs-keyword">cd</span> <span class="hljs-string">..</span><br></code></pre></div></td></tr></table></figure><h3 id="netcdf"><a href="#netcdf" class="headerlink" title="netcdf"></a>netcdf</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">tar -zxf netcdf-4.4.1.tar.gz<br><span class="hljs-keyword">cd</span> netcdf-4.4.1<br>CPPFLAGS=<span class="hljs-string">"-l/opt/hdf4/include -l/opt/hdf5/include -l/opt/jpeg/include"</span><br>LDFLAGS=<span class="hljs-string">"-l/opt/hdf4/lib -l/opt/hdf5/lib -l/opt/jpeg/lib"</span><br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/opt/netcdf</span> <span class="hljs-params">--enable-hdf5</span> <span class="hljs-params">--with-hdf5=/opt/hdf5</span> <span class="hljs-params">--enable-hdf4</span> <span class="hljs-params">--with-hdf4=/opt/hdf4</span> <span class="hljs-params">--enable-jpeg</span> <span class="hljs-params">--with-jpeg=/opt/jpeg</span> <span class="hljs-params">--disable-netcdf-4</span><br>make<br>make install<br><span class="hljs-keyword">cd</span> <span class="hljs-string">..</span><br></code></pre></div></td></tr></table></figure><h4 id="gdal"><a href="#gdal" class="headerlink" title="gdal"></a>gdal</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">unzip gdal233.zip<br><span class="hljs-keyword">cd</span> gdal-2.2.3<br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/opt/gdal</span> <span class="hljs-params">--enable-netcdf</span> <span class="hljs-params">--with-netcdf=/opt/netcdf</span> <span class="hljs-params">--enable-hdf5</span> <span class="hljs-params">--with-hdf5=/opt/hdf5</span> <span class="hljs-params">--enable-hdf4</span> <span class="hljs-params">--with-hdf4=/opt/hdf4</span><br>make<br>make install<br><span class="hljs-keyword">cd</span> <span class="hljs-string">..</span><br></code></pre></div></td></tr></table></figure><p>gdalinfo 验证一下</p><h3 id="swig"><a href="#swig" class="headerlink" title="swig"></a>swig</h3><p>yum install pcre<br>yum install pcre-devel</p><figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">tar -zxf swig<span class="hljs-number">-3.0</span><span class="hljs-number">.12</span>.tar.gz<br>cd swig<span class="hljs-number">-3.0</span><span class="hljs-number">.12</span><br>./configure<br>make<br>make install<br></code></pre></div></td></tr></table></figure><p>检验安装swig -help</p><h2 id="4-修改配置文件"><a href="#4-修改配置文件" class="headerlink" title="4.修改配置文件"></a>4.修改配置文件</h2><p>vi  /etc/profile<br>加入</p><figure class="highlight elixir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elixir">export PATH=<span class="hljs-variable">$&#123;</span>PATH&#125;<span class="hljs-symbol">:/opt/hdf4/include</span><span class="hljs-symbol">:/opt/hdf4/bin</span><span class="hljs-symbol">:/opt/hdf5/include</span><span class="hljs-symbol">:/opt/hdf5/bin</span><span class="hljs-symbol">:/opt/netcdf/include</span><span class="hljs-symbol">:/opt/netcdf/bin</span><span class="hljs-symbol">:/opt/gdal/include</span><span class="hljs-symbol">:/opt/gdal/bin</span><br>export LD_LIBRARY_PATH=<span class="hljs-variable">$&#123;</span>LD_LIBRARY_PATH&#125;<span class="hljs-symbol">:/opt/hdf4/lib</span><span class="hljs-symbol">:/opt/hdf5/lib</span><span class="hljs-symbol">:/opt/netcdf/lib</span><span class="hljs-symbol">:/opt/gdal/lib</span><br></code></pre></div></td></tr></table></figure><p>source  /etc/profile</p><h1 id="编译gdal-java"><a href="#编译gdal-java" class="headerlink" title="编译gdal-java"></a>编译gdal-java</h1><h2 id="1、安装jdk"><a href="#1、安装jdk" class="headerlink" title="1、安装jdk"></a>1、安装jdk</h2><p>略</p><h2 id="2、编译jar和jni文件"><a href="#2、编译jar和jni文件" class="headerlink" title="2、编译jar和jni文件"></a>2、编译jar和jni文件</h2><p>进入<gdal-dir>\swig\java修改java.opt文件，指定jdk的路径，<gdal-dir>为gdal文件夹。内容如下： </p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile">JAVA_HOME = /opt/jdk1.8<br>JAVADOC=<span class="hljs-variable">$(JAVA_HOME)</span>/bin/javadoc <br>JAVAC=<span class="hljs-variable">$(JAVA_HOME)</span>/bin/javac <br>JAVA=<span class="hljs-variable">$(JAVA_HOME)</span>/bin/java <br>JAR=<span class="hljs-variable">$(JAVA_HOME)</span>/bin/jar <br>JAVA_INCLUDE=-I<span class="hljs-variable">$(JAVA_HOME)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(JAVA_HOME)</span>/<span class="hljs-keyword">include</span>/linux<br></code></pre></div></td></tr></table></figure><p>编译需要ant支持，所以:</p><figure class="highlight cmake"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> ant<br></code></pre></div></td></tr></table></figure><p>编译,并将so文件拷贝出来</p><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">cd</span> &lt;gdal&gt;<span class="hljs-string">/swig/java/</span><br>make<br><span class="hljs-keyword">cd</span> <span class="hljs-string">.libs/</span><br><br>cp *<span class="hljs-string">.so</span> <span class="hljs-string">/usr/local/gdalso/</span><br></code></pre></div></td></tr></table></figure><p>同时，目录下会生成gdal.jar，拷贝到项目中就可以用了，需要注意的是，这个jar在win和linux下并不通用</p><p>vi ~/.bashrc ,加上环境变量</p><figure class="highlight elixir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elixir">export LD_LIBRARY_PATH=<span class="hljs-variable">$&#123;</span>LD_LIBRARY_PATH&#125;<span class="hljs-symbol">:/usr/local/gdalso</span><br></code></pre></div></td></tr></table></figure><p>使环境变量生效，source ~/.bashrc</p><p>完成了，享受急速的栅格数据处理性能吧~</p>]]></content>
    
    
    <categories>
      
      <category>部署运维</category>
      
      <category>软件安装</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gdal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>postgis空间数据格式解析，及如何绑定变量</title>
    <link href="/2018/03/21/2018-03-21-parse-postgis-shape/"/>
    <url>/2018/03/21/2018-03-21-parse-postgis-shape/</url>
    
    <content type="html"><![CDATA[<p>当我们往postgis的shape字段中插入一条数据</p><figure class="highlight sql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test1 (shape)<br><span class="hljs-keyword">VALUES</span> (GeomFromEWKT(<span class="hljs-string">'SRID=4326;POINT(116.39 39.9)'</span>));<br></code></pre></div></td></tr></table></figure><p>读出来的shape是这样的:</p><figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript"><span class="hljs-number">0101000020E6100000295</span>C8FC2F5185D403333333333F34340<br></code></pre></div></td></tr></table></figure><p>显然，这是一个wkb格式的字符串嘛</p><p>于是，在java中，我们只需用jts的WKBReader类，便可直接将其解析为geometry对象</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">WKBReader wkbReader = <span class="hljs-keyword">new</span> <span class="hljs-constructor">WKBReader()</span>;<br>......此处略去jdbc的一堆套路<br>PGobject obj = (PGobject) rs.get<span class="hljs-constructor">Object(<span class="hljs-string">"shape"</span>)</span>;<br>byte<span class="hljs-literal">[]</span> <span class="hljs-built_in">bytes</span> = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WKBReader</span>.</span></span>hex<span class="hljs-constructor">ToBytes(<span class="hljs-params">obj</span>.<span class="hljs-params">getValue</span>()</span>);<br>Geometry geo = wkbReader.read(<span class="hljs-built_in">bytes</span>);<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(geo);<br></code></pre></div></td></tr></table></figure><p>我们发现，postgreSQL用PGobject来描述自定义数据类型，而空间数据的type是geometry，所以，我们可以这样绑定变量来做预解析：</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">double<span class="hljs-literal">[]</span> bbox = <span class="hljs-keyword">new</span> double<span class="hljs-literal">[]</span>&#123;<br>        <span class="hljs-number">90</span>, <span class="hljs-number">20</span>, <span class="hljs-number">120</span>, <span class="hljs-number">30</span><br>&#125;;<br>Coordinate<span class="hljs-literal">[]</span> coords = <span class="hljs-keyword">new</span> Coordinate<span class="hljs-literal">[]</span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">Coordinate(<span class="hljs-params">bbox</span>[0], <span class="hljs-params">bbox</span>[1])</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">Coordinate(<span class="hljs-params">bbox</span>[2], <span class="hljs-params">bbox</span>[1])</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">Coordinate(<span class="hljs-params">bbox</span>[2], <span class="hljs-params">bbox</span>[3])</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">Coordinate(<span class="hljs-params">bbox</span>[0], <span class="hljs-params">bbox</span>[3])</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">Coordinate(<span class="hljs-params">bbox</span>[0], <span class="hljs-params">bbox</span>[1])</span>,<br>&#125;;<br>LinearRing shell = gf.create<span class="hljs-constructor">LinearRing(<span class="hljs-params">coords</span>)</span>;<br>Geometry env = gf.create<span class="hljs-constructor">Polygon(<span class="hljs-params">shell</span>)</span>;<br>PGobject param = <span class="hljs-keyword">new</span> <span class="hljs-constructor">PGobject()</span>;<br><span class="hljs-comment">//sql及绑定变量这样写  "select * from test1 ? &amp;&amp; shape", param</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>服务端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PostgreSQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tomcat启动报错ZipException: error in opening zip file及解决</title>
    <link href="/2017/11/30/2017-11-30-zip-exception/"/>
    <url>/2017/11/30/2017-11-30-zip-exception/</url>
    
    <content type="html"><![CDATA[<p>今天早上到公司，照例从git更新了一下项目，然后开始干活，发现tomcat起不来了，报错如下:</p><figure class="highlight stata"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stata">java.util.<span class="hljs-keyword">zip</span>.ZipException: <span class="hljs-keyword">error</span> <span class="hljs-keyword">in</span> opening <span class="hljs-keyword">zip</span> <span class="hljs-keyword">file</span><br></code></pre></div></td></tr></table></figure><p>打开zip文件出错？？然而项目里没有什么zip文件啊。。于是，我猜想，项目里，能用zip工具打开的，只有jar包了吧。</p><p>ok，删掉WEB-INF/lib下所有的jar，tomcat能启动了(当然，此时项目由于缺少依赖的jar无法正常启动)。</p><p>emmmmm，这下问题找到了，应该是一个或几个jar包坏掉了，接下来就是找到坏掉的jar，可是项目好大啊，上百个jar包怎么排查呢？当然是二分法查找了，时间复杂度只有O(logn)根本不虚好么2333 :dog: 。通俗点说就是先删掉一半jar包，如果报错找不到某个类，说明有问题的jar在删掉的那一半jar里，然后从删掉那一半里再缩小范围。</p><p>数分钟后，找到了两个jar，果然用zip工具打不开-_-!，maven仓库里找到它们，删掉对应的文件夹，重新下载，问题解决~ :hatched_chick: </p><p>最后，吐槽一下这两个jar是怎么坏掉的，我司安全管理较严格，上网需要在电脑上插一个usb key，没这个key就会把你访问的网址转到一个”你尚未通过安全校验，请先巴拉巴拉”的一个页面。</p><p>然后悲剧就这样发生了，大概是上午更新完代码后，maven正在下载依赖时，我不小心碰到了usb key导致key断开了 :eyes: ，然后，下载下来的pom就变成这样了：<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/5f94f725-4061-48b8-bb5d-25aa1e932967" alt="233"></p><p>整个人都不好了啊喂-_-!</p><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; Updated upstream<br>本文发布于<a href="http://blog.wowtools.org/2017/11/30/zip-exception/">http://blog.wowtools.org/2017/11/30/zip-exception</a>,转载请注明出处。</p><p>=======</p><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><p>Stashed changes</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
      <category>异常</category>
      
    </categories>
    
    
    <tags>
      
      <tag>奇葩问题</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>arcgis 发布图层</title>
    <link href="/2017/09/05/2017-09-05-arcgis-publishing-layer/"/>
    <url>/2017/09/05/2017-09-05-arcgis-publishing-layer/</url>
    
    <content type="html"><![CDATA[<p>好久没用arcgis了，发布图层的步骤老是忘-_-，简单记录一下吧</p><h1 id="制作地图文档"><a href="#制作地图文档" class="headerlink" title="制作地图文档"></a>制作地图文档</h1><h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h2><p>打开ArcMap，新建一个地图文档，右键点击”图层”-&gt;”添加数据”，选择需要加入的数据</p><p><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-05-arcgis-publishing-layer-1" alt="此处输入图片的描述"></p><p>若加入的是tif之类的文件，且需要去除黑边，可右键此图层-&gt;属性，勾选”显示背景值”，并设为无颜色:</p><p><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-2" alt="此处输入图片的描述"></p><h2 id="修改坐标系"><a href="#修改坐标系" class="headerlink" title="修改坐标系"></a>修改坐标系</h2><p>右键点击”图层”-&gt;”属性”，设置为需要的坐标系<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-3" alt="此处输入图片的描述"></p><p>最后将其存为mxd文档。</p><h1 id="发布服务"><a href="#发布服务" class="headerlink" title="发布服务"></a>发布服务</h1><h2 id="预先配置一下arcgis-server"><a href="#预先配置一下arcgis-server" class="headerlink" title="预先配置一下arcgis server"></a>预先配置一下arcgis server</h2><p>打开ArcCatalog，在左侧目录树的”gis服务器”下选择”添加arcgis server”，然后根据自己arcgis server的连接信息，一路下一步，添加一个server。<br>然后打开arcserver的web控制台，大概路径像这样：<br><a href="http://localhost:6080/arcgis/manager/index.html" target="_blank" rel="noopener">http://localhost:6080/arcgis/manager/index.html</a></p><p>我们需要配置”站点”选项卡下的几个东西：</p><h3 id="缓存目录"><a href="#缓存目录" class="headerlink" title="缓存目录"></a>缓存目录</h3><p>在”目录”下，修改缓存目录的位置到一个剩余磁盘空间比较大的路径，也可以添加多个缓存目录，在后面的步骤里为不同的图层指定不同的缓存目录。<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-4" alt="此处输入图片的描述"></p><h3 id="Data-Store里注册文件夹"><a href="#Data-Store里注册文件夹" class="headerlink" title="Data Store里注册文件夹"></a>Data Store里注册文件夹</h3><p>做这步操作的原因是，即使你在本机上制作mxd/sd文档并发布到本机的arcgis server，arcserver仍然会把mxd用到的数据文件上传到arcserver的目录下，这就很蛋疼了。。<br>于是，我们需要把数据文件所在的文件夹注册进来，这样mxd用到这个文件夹中的文件时就不需要上传了。<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-5" alt="此处输入图片的描述"></p><h2 id="发布地图文档"><a href="#发布地图文档" class="headerlink" title="发布地图文档"></a>发布地图文档</h2><p>好了，现在可以开始发布刚才制作好的mxd了，在ArcMap中，点击”文件”-&gt;”共享为”-&gt;”服务”，看到如下界面:<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-6" alt="此处输入图片的描述"></p><p>选择”发布服务”的话，就能直接把mxd发成图层，”保存服务定义文件”则会生成一个sd文档。过程大同小异，一路下一步，设置一些常规信息，来到这一步：<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-7" alt="此处输入图片的描述"></p><p>特别说一下缓存这里</p><h3 id="缓存配置"><a href="#缓存配置" class="headerlink" title="缓存配置"></a>缓存配置</h3><p>也就是瓦片地图切片。<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-8" alt="此处输入图片的描述"></p><p>缓存的高级设置下面，可以选择切片的缓存目录，能选择的目录就是前文中arcgis server里配置过的。<br>高级设置的高级按钮(谁起的名字-_-)里，可以设置切片的存储是松散型还是紧凑型，松散型切出来就是一张张图片，级别较高时图片数量会非常大，所以一般我们不太去用这种格式；紧凑型格式的解析可以参考<a href="http://www.cnblogs.com/ssai2015/p/4926323.html" target="_blank" rel="noopener">这个帖子</a>，需要注意的7是，低版本的arcserver切出来的bundle、bundlex文件是分开的。</p><p>好啦，配置完成，点一下分析按钮，没有错误的话点击发布，稍等片刻就文档就发布到arcserver上了。如果配置了切片，切片任务会在arcserver的后台执行，所以关掉arcmap、catalog也没问题。随后，可以在catalog里右键此图层-&gt;查看缓存状态-&gt;详细信息 来查看切片进度。<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/2017-09-5-arcgis-publishing-layer-9" alt="此处输入图片的描述"></p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>工具和软件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>arcgis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>geoserver gwc</title>
    <link href="/2016/11/28/2016-11-28-geoserver-gwc/"/>
    <url>/2016/11/28/2016-11-28-geoserver-gwc/</url>
    
    <content type="html"><![CDATA[<p> <strong>- 简介</strong></p><p>gwc，是“Geo Web Cache”的简称。它是一种带缓存的地图服务，但与TileLayer的工作机制又不太一样。我们先回顾一下两种常规的地图服务模式：</p><p>DynamicLayer：动态图，即每次接收到用户的出图请求后，根据用户传过来的地图范围，查询范围内的要素并绘制成图片返回给用户。由于每次出图请求都需要查询和绘制，效率一般不会很高。</p><p>TileLayer：根据指定的切图原点，切图范围等参数，预先将绘制好瓦片图并保存起来，当用户请求某个范围内的地图时，计算此范围覆盖了哪些瓦片并将这些切片返回给用户。由于瓦片是预先绘制好的，直接返回就行了，所以速度很快。TileLayer也有很多缺点，实时性不高，每次切图很耗时(几十天甚至几个月一点都不稀奇)，而且占用很大的磁盘空间，某级别下的某些区域用户可能根本不会去访问，这就白白浪费了切图的时间和磁盘。</p><p>gwc是结合DynamicLayer和TileLayer的一种折衷方案：先不做预切图(当然也可以做，这个在下面实际使用时再具体说明)，当用户发送某个范围的出图请求时，计算范围内需要哪些切片，然后去缓存文件夹中找，没找到的话先临时生成一个丢到缓存文件夹里，把这些切片作适当的缩放和裁剪，再拼起来返回给用户。</p><hr><p> <strong>- 如何使用</strong></p><p>首先，可以在web.xml文件里配置一下gwc切片目录：</p><blockquote><p> &lt;context-param&gt;<br>   &lt;param-name&gt;GEOWEBCACHE_CACHE_DIR&lt;/param-name&gt;<br>   &lt;param-value&gt;你的geowebcache切片的目录&lt;/param-value&gt;<br>  &lt;/context-param&gt;</p></blockquote><p>不配的话，tomcat里运行默认是存在tomcat的temp目录下。</p><p> 然后进入geoserver的管理界面，我们看到Tile Cacing下一共五个子目录：<br><strong>Tile LayersTile Layers</strong><br>gwc图层的配置、查看、预切图等<br><strong>Caching Defaults</strong><br>一些默认设置<br><strong>Gridsets</strong><br>切图网格的设置<br><strong>Disk Quota</strong><br>磁盘存储设置，比如设置最大磁盘占用50g，当缓存文件超过50g后，会按最近最少使用之类的规则清理掉一些旧的<br><strong>BlobStores</strong><br>允许我们指定存储位置、磁盘blocksize等，以更合理地使用磁盘</p><p>我们先在Gridsets里，按照所用的地图信息配置一个切图网格：<br>![此处输入图片的描述][2]<br>遗憾的是不能直接修改坐标原点，导致切出来的瓦片不能直接拷贝出来丢给arcgis之类的使用，当然这个可以通过自定义坐标系来解决。</p><p>选择需要gwc的图层，<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/c4428e71-931d-4902-afe2-ecc84f4ea2eb" alt=""></p><p>好了，准备工作完成，下面可以开始使用了：<br>点击Tile Layers,Preview下拉框选择一个想要的图片格式和grid，就可以预览了(预览页面右键查看源代码，就有openlayers调用gwc的方法了^_^)。</p><p>如果想对指定区域进行预切片，只要点击Seed/Truncate，选好参数就可以开切了，不过geoserver切图性能堪忧，可以考虑用arcgis、gdal之类的切好了再丢到gwc缓存目录里。</p><p> <strong>- 关于resolution</strong></p><p> 比较一下gwc和wms请求图片的url：</p><div class="hljs code-wrapper"><pre><code>gwc:geoserver/gwc/service/wms?LAYERS=xxx&amp;...&amp;SRS=EPSG%3A3857&amp;BBOX=xxxwms:geoserver/&lt;workspace&gt;/wms?LAYERS=xxx&amp;...&amp;SRS=EPSG%3A3857&amp;BBOX=xxx</code></pre></div><p>我们发现，gwc除了前缀url路径不一样，后面的请求参数和wms几乎是一样的，也就是说，gwc并不是像TileLayer那样直接把切片返回到客户端，而是需要通过bbox去计算需要哪些切片，然后做适当的拼接、裁剪、缩放。</p><p>如果同一个空间参考系配置了多个grid，geoserver会去计算请求图片的resolution与哪个grid更接近就用哪个grid。</p><p>如果请求图片的resolution与grid的resolution相差较大，会导致图片过大地缩放，然后图片质量就不好了，这是网上找的一张图：<br><img src="http://7xlvcv.com1.z0.glb.clouddn.com/114be441-b6ae-4630-b0e5-b0f5446cf2a1" alt=""></p><p> 如果resolution相差再大一些，geoserver就直接抛个异常说resolution相差不能超过10%了。</p><p> 所以，在使用gwc时，请尽量按照客户端地图的resolution来配置一套grid，以获得最佳浏览效果。</p>]]></content>
    
    
    <categories>
      
      <category>gis</category>
      
      <category>工具和软件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>geoserver</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
